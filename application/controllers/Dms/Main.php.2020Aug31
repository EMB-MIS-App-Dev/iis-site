<?php
  if ( ! defined('BASEPATH')) exit('No direct script access allowed');
  error_reporting(E_ALL);
  // error_reporting(0);
  /*
  * segment 1 - dms
  * segment 2 - documents
  * segment 3 - actions (add, route, revise)
  */
  class Main extends CI_Controller
  {
    private $dmsdata;
    function __construct()
    {
      parent::__construct();
      // USER SESSION CHECK
      if ( empty($this->session->userdata('token')) ) {
        echo "<script>alert('Session Timeout. Please Re-Login.'); window.location.href='".base_url()."';</script>";
      }

      $this->load->model('Embismodel');
      $this->load->helper(array('form', 'url'));

      $this->load->library('session');
      $this->load->library('form_validation');
      $this->load->library('upload');
      $this->load->library('encryption');

      date_default_timezone_set("Asia/Manila");

      $this->dmsdata = array(
        'user_id'     => $this->session->userdata('userid'),
        'user_region' => $this->session->userdata('region'),
        'user_token'  => $this->session->userdata('token'),
      );
      $this->dmsdata['user'] = array(
        'id'      => $this->session->userdata('userid'),
        'token'   => $this->session->userdata('token'),
        'region'  => $this->session->userdata('region'),
        'secno'   => $this->session->userdata('secno'),
        'divno'   => $this->session->userdata('divno'),
      );
    }

    function index()
    {
      $this->load->view('includes/common/header');
      $this->load->view('includes/common/sidebar');
      $this->load->view('includes/common/nav');
      $this->load->view('includes/common/footer');
      $this->load->view('includes/common/dms_styles');

      $this->load->view('Dms/include/custom_head');
      $this->load->view('Dms/include/custom_foot');

      if($this->uri->segment(1) != 'dms' && $this->uri->segment(2) != 'documents') {
        redirect(base_url('error_404'));
      }

      if($this->uri->segment(2) === 'documents' && !empty($this->uri->segment(3))) { // ADD XSS_CLEAN
        // $this->dmsdata['er_options'] = $this->Embismodel->selectdata('er_options', '*', array('userid'=>$this->dmsdata['user']['id']))[0];
        $this->router();
      }
      else {
        redirect(base_url('dms/documents/all'));
      }
    }

    private function router() // MAINLY FOR URI SEGMENT CHECKING ONLY
    {
      switch ($this->uri->segment(3)) {
        case 'debug':
            $this->array_debug($_SESSION);
          break;

        case 'all':
            $this->load->view('Dms/func/modals');
            $this->all_transactions();
          break;

        case 'inbox':
            $this->load->view('Dms/func/modals');
            $this->inbox();
          break;

        case 'outbox':
            $this->load->view('Dms/func/modals');
            $this->outbox();
          break;

        case 'process': // SEPARATE TO ANOTHER DMS CONTROLLER FILE
            if(!empty($this->uri->segment(4)) && !empty($this->uri->segment(5)) && !empty($this->uri->segment(6)) && !empty($this->uri->segment(7))) {
              $this->load->view('Dms/include/modals');
              $this->route_transaction();
            }
            else {
              $this->_alert('', '', '[PRC-ROUTE]');
            }
          break;

        case 'planning':
            $this->load->view('Dms/func/modals');
            $this->planning_report();
          break;

        case 'mod':
            if(!empty($this->uri->segment(4)) && $this->uri->segment(4) == 'filetransfer') {
              $this->trans_transfer();
            }
            else {
              $this->array_debug($_SESSION);
            }
          break;

        default:
            $this->_alert('', '', '[SEG-THR]');
          break;
      }
    }

    private function array_debug($data='') { $data['data'] = $data; $this->load->view('Dms/debug', $data); }

    private function _alert($alert_data="", $redirect_page="", $code="", $type="")
    {
      $asd = '';
      if(empty($alert_data)) {
        $alert_data = array(
          'title'     => 'NOTE',
          'text'      => 'You have Accessed an Unidentified Page and have been Redirected to this Page. '.$code,
          'type'      => 'warning',
        );
      }
      if(empty($type)) {
        $this->session->set_flashdata('bthead_alert_data', $alert_data);
      }
      else {
        $this->session->set_flashdata('swal_alert_data', $alert_data);
      }

      if(empty($redirect_page)) {
        $redirect_page = base_url('dms/documents/all');
      }
      redirect($redirect_page);
    }

    private function validate_session()
    {
      $where_ucred = array(
        'userid'   => $this->dmsdata['user']['id'],
        'verified' => 1,
      );
      $session_ucred = $this->Embismodel->selectdata('acc_credentials', '*', $where_ucred)[0];

      if($session_ucred['region'] != $this->dmsdata['user']['region'] || $session_ucred['secno'] != $this->dmsdata['user']['secno'] || $session_ucred['divno'] != $this->dmsdata['user']['divno']) {
        $this->dmsdata['user'] = array(
          'id'      => $session_ucred['userid'],
          'token'   => $session_ucred['token'],
          'region'  => $session_ucred['region'],
          'secno'   => $session_ucred['secno'],
          'divno'   => $session_ucred['divno'],
        );
      }
    }

// -------------------------------------------- VIEWS ------------------------------------------ //
    // ------------------------------- DOCUMENTS (MAIN) ----------------------------------
    private function all_transactions()
    {
      $data = array(
        'user_region'  => $this->dmsdata['user_region'],
        'user_token'   => $this->dmsdata['user_token'],
      );
      $data['region'] = $this->Embismodel->selectdata('acc_region', '*', '');
      $this->load->view('Dms/all_transactions', $data);
    }

    private function inbox()
    {
      $data = array(
        'user_region'  => $this->dmsdata['user_region'],
        'user_token'   => $this->dmsdata['user_token'],
      );
      $this->load->view('Dms/inbox1', $data);
    }

    private function outbox()
    {
      $data = array(
        'user_region'  => $this->dmsdata['user_region'],
        'user_token'   => $this->dmsdata['user_token'],
      );
      $this->load->view('Dms/outbox', $data);
    }

    private function route_transaction()
    {
      /*
      * segment 4 - entry
      * segment 5 - trans_no
      * segment 6 - main_multi_cntr
      * segment 7 - multi_cntr
      */
      $encrpty = trim($this->uri->segment(4).';'.$this->uri->segment(5).';'.$this->uri->segment(6).';'.$this->uri->segment(7));
      $data = array(
        'entry'           => $this->uri->segment(4),
        'trans_no'        => $this->uri->segment(5),
        'enc_key'         => $this->encrypt->encode($encrpty),
        'user_region'     => $this->dmsdata['user_region'],
        'user_token'      => $this->dmsdata['user_token'],
      );
      $data['user'] = $this->dmsdata['user'];
      // VERIFY IF TRANSACTION IS INDEED ROUTED TO USER
      $rslt_trans = '';
      $where_trans = array(
        'trans_no'        => $this->uri->segment(5),
        'receiver_id'     => $this->dmsdata['user_token'],
      );
      // CHECK WHICH TABLE TO LOOK
      if($this->uri->segment(4) == 1) {
        if($this->uri->segment(6) == 1 && $this->uri->segment(7) == 1) {
          $data['main_multi_cntr'] = '';
          $data['multi_cntr'] = 1;
          $rslt_trans = $this->Embismodel->selectdata('er_transactions', '*', $where_trans);
        }
      }
      else {
        $where_trans['main_multi_cntr'] = $data['main_multi_cntr'] = $this->uri->segment(6);
        $where_trans['multi_cntr'] = $data['multi_cntr'] = $this->uri->segment(7);
        $rslt_trans = $this->Embismodel->selectdata('er_transactions_multi', '*', $where_trans);
      }
      // EMPTY RESULT
      if(!$rslt_trans) { $this->_alert('', base_url('dms/documents/inbox'), '[RTE-RES-TRNS]'); }
      // GET SELECT DROPDOWNS
      $data['trans_data'] = $rslt_trans;
      $data['regions'] = $this->Embismodel->selectdata('acc_region', '*');
      $data['system'] = $this->Embismodel->selectdata('er_systems', '*', '', $this->db->order_by('system_order', 'asc'));
      $data['status'] = $this->Embismodel->selectdata('er_status', '*', array('id !=' => 1), $this->db->order_by('status_order', 'asc'));
      $data['action'] = $this->Embismodel->selectdata('er_action', '*');

      // $data['company_list'] = $this->Embismodel->selectdata('dms_company', 'emb_id, company_id, company_name, establishment_name, token', array('deleted' => 0));
      // $trans_where = array( 'et.trans_no' => $this->dmsdata['trans_session'] );
      // if($this->dmsdata['trans_data'][0]['multiprc'] > 0) {
      //   $trans_where = array(
      //     'et.trans_no'     => $this->dmsdata['trans_session'],
      //     'et.receiver_id'  => $this->dmsdata['user_token'],
      //   );
      //   $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions_multi AS et', '', $trans_where);
      // }
      // $cred_where = array('ac.region' => $this->dmsdata['trans_data'][0]['region'], 'ac.verified' => 1 );
      // $this->dmsdata['trans_cred'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $cred_where);
      // $accred_where = array('ac.token' => $this->dmsdata['user_token']);
      // $this->dmsdata['credentials'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $accred_where);

      // VIEWING OF COMPANY DETAILS
      $data['company_details'] = $this->Embismodel->selectdata('dms_company ', '*', array( 'token' => $data['trans_data'][0]['company_token'] ) );
      // USED FOR FUNCTION SELECTION WHEN USER HAS MULTIPLE FUNCTIONS
      $where_afunc = array('userid' => $this->dmsdata['user']['id'], 'stat' => 1 );
      $data['function'] = $this->Embismodel->selectdata('acc_function', '*', $where_afunc);
      /* QUERIES AFTER THIS COMMENT ARE ALL TRANSACTIONAL BASE */
      // ATTACHMENT
      $route_order = ($data['trans_data'][0]['route_order'] == 0) ? 1 : $data['trans_data'][0]['route_order'];
      $where_attach = array(
        'trans_no'     => $data['trans_no'],
        'route_order'  => $route_order+1,
        'deleted'      => 0,
      );
      $data['attachments'] = $this->Embismodel->selectdata('er_attachments', '*', $where_attach);
      $data['trans_type'] = $this->Embismodel->selectdata('er_type', '*', array( 'sysid' => $this->dmsdata['trans_data'][0]['system'] ), $this->db->order_by('sysid asc, ssysid asc, header desc'));
      // LIMITS AVAILABLE SELECTION OF ASSIGNED PERSONNEL
      // $this->assigned_slctn();
      // SUB-SYSTEM TYPES VIEW APPEND TO MAIN VIEW
      // $this->add_inputs();
      $history = array(
        'where' => array(
          'trans_no'          => $data['trans_no'],
          'main_multi_cntr'   => '', // $data['main_multi_cntr'],
          // 'multi_cntr'        => $data['multi_cntr'],
        ),
        'order' => $this->db->order_by('main_route_order ASC, route_order ASC, multi_cntr ASC'),
      );
      $data['trans_history'] = $this->Embismodel->selectdata( 'er_transactions_log', '*', $history['where'], $history['order'] );
      // NO NEED, MIGHT DELETE LATER
      $where_inthread = $this->db->where('trans_no = "'.$data['trans_no'].'" AND ( sender_id = "'.$data['user']['token'].'" OR receiver_id =  "'.$data['user']['token'].'" )');
      $data['prnl_inthread'] = $this->Embismodel->selectdata('er_transactions_log', 'trans_no', '', $where_inthread );

      // query of attachments
      // foreach ($this->dmsdata['trans_history'] as $key => $value) {
      //   $ea_where = array(
      //     'eat.trans_no'    => $value['trans_no'],
      //     'eat.route_order' => $value['route_order'],
      //     'eat.deleted'     => 0,
      //   );
      //   $ea_order = $this->db->order_by('eat.route_order', 'desc');
      //   $this->dmsdata['attachment_view'][$key] = $this->Embismodel->selectdata('er_attachments AS eat', '', $ea_where, $ea_order );
      //
      //   $from_name['where'] = array( 'acd.token' => $value['sender_id'], );
      //   $from_name['cred'] = $this->Embismodel->selectdata('acc_credentials AS acd', '', $from_name['where'] );
      //
      //   $from_name['axs_where'] = array( 'axs.secno' => $from_name['cred'][0]['secno'] );
      //   $from_name['sec'] = $this->Embismodel->selectdata('acc_xsect AS axs', '', $from_name['axs_where'] );
      //   $from_sec = (!empty($from_name['sec'])) ? '|'.$from_name['sec'][0]['secode'] : '';
      //
      //   $this->dmsdata['from_name'][$key] = !empty($from_name['cred'][0]['division']) ? $from_name['cred'][0]['division'].$from_sec.'-' : '';
      //
      //   $receiver_name['axd_where'] = array( 'axd.divno' => $value['receiver_divno'], 'axd.office' => 'EMB' );
      //   $receiver_name['div'] = $this->Embismodel->selectdata('acc_xdvsion AS axd', '', $receiver_name['axd_where'] );
      //   $receiver_div = (!empty($receiver_name['div'])) ?  $receiver_name['div'][0]['divcode'] : '';
      //
      //   $receiver_name['axs_where'] = array( 'axs.secno' => $value['receiver_secno'] );
      //   $receiver_name['sec'] = $this->Embismodel->selectdata('acc_xsect AS axs', '', $receiver_name['axs_where'] );
      //   $receiver_sec = (!empty($receiver_name['sec'])) ? '|'.$receiver_name['sec'][0]['secode'] : '';
      //
      //   $this->dmsdata['receiver_name'][$key] = $receiver_div.$receiver_sec.' - ';
      //
      //   if($value['multiprc'] > 0)
      //   {
      //     $where['etml'] = array(
      //       'etml.trans_no'           => $value['trans_no'],
      //       'etml.main_route_order'   => $value['route_order'],
      //       'etml.route_order'        => 1,
      //       'etml.main_multi_cntr'    => $value['multi_cntr'],
      //     );
      //     $this->dmsdata['multitrans_histo'] = $this->Embismodel->selectdata('er_transactions_log AS etml', '', $where['etml'] );
      //   }
      // }
      //
      // $this->dmsdata['courier_type'] = $this->Embismodel->selectdata('er_courier AS ec', '', '');
      //

      // echo '<pre>' . print_r($data, TRUE) . '</pre>';
      $this->validate_form('Dms/func/route_transaction1', $data);
    }

    // -------------------- PLANNING -----------------------
    private function planning_report()
    {
      $data = array(
        'user_region'  => $this->dmsdata['user_region'],
        'user_token'   => $this->dmsdata['user_token'],
      );
      $this->load->view('Dms/Planning/'.$this->uri->segment(4), $data);
      // if (is_file(APPPATH.'Dms/Planning/'.$this->uri->segment(4).EXT))
      // // if ($this->load->view('Dms/Planning/'.$this->uri->segment(4), '', TRUE) !== '')
      // {
      //   $this->load->view('Dms/Planning/'.$this->uri->segment(4), $data);
      // }
      // else {
  		//     $this->load->view('404');
      // }
    }

    // -------------------- MODIFICATION TOOLS -----------------------
    private function trans_transfer()
    {
      $data = array(
        'user_region'  => $this->dmsdata['user_region'],
        'user_token'   => $this->dmsdata['user_token'],
      );
      $this->load->view('Dms/mod/file_transfer', $data);
    }

// ------------------------------------------- FORM VALIDATIONS ------------------------------------------ //
    private function validate_form($site="", $data="")
    {
      if(empty($site)) {
        $alert_data = array(
          'title'     => 'ERROR',
          'text'      => 'Route Site Destination Not Set, Causes might be a Network Interruption. Please check the site, or Contact System Administrator. [VF-EMPST]',
          'type'      => 'error',
        );
        $this->_alert($alert_data);
      }
      // CHECK SESSION'S USER DATA MATCHES DATABASE DATA
      $this->validate_session();

      if(isset($_POST['process_transaction']))
      {
        $this->form_validation->set_error_delimiters(' <span class="set_error">', '</span>');

        $this->form_validation->set_rules('system', '', 'required');
        $this->form_validation->set_rules('type', '', 'required');
        $this->form_validation->set_rules('subject', '', 'required');
        $this->form_validation->set_rules('status', '', 'required');
        $this->form_validation->set_rules('company', '', 'required');

        if (empty(($this->input->post('asgnto_multiple'))))
        {
          if(!in_array($this->input->post('status'), array('17', '18', '19', '24', '27'))) // END STATUS
          {
            $this->form_validation->set_rules('division', '', 'required');
            $this->form_validation->set_rules('section', '', 'required');
            $this->form_validation->set_rules('receiver', '', 'required');
          }
        }

        $this->form_validation->set_rules('action', '', 'required');

        // FIRST TRANSACTION ROUTE
        if($this->dmsdata['trans_data'][0]['route_order'] == 0) {
          $this->form_validation->set_rules('attachment', '', 'callback_attachment_exists');
        }

        // TRANSACTION STATUS "FOR FILING / CLOSED"
        if($this->input->post('status') == 24)
        {
          // RECORDS SECTION
          if($this->dmsdata['user_func']['secno'] == '77')
          {
            $this->form_validation->set_rules('records_location', '', 'required');
          }
          $this->form_validation->set_rules('attachment', '', 'callback_attachment_exists');
        }
        // SENT VIA COURIER
        if($this->input->post('status') == '19') {
          $this->form_validation->set_rules('courier_type', '', 'required_courier');
        }

        $this->form_validation->set_message('required', '( required )' );
        $this->form_validation->set_message('attachment_exists', '( required )' );
        $this->form_validation->set_message('required_courier', '( For "Sent Via Courier", Courier Type is Required )' );

        if($this->form_validation->run() == FALSE)
        {
          $this->load->view($site, $data);
        }
        else {
          $this->process_transaction1();
        }
      }
      // else if(isset($_POST['save_draft']))
      // {
      //   $this->save_draft();
      // }
      else {
        $this->load->view($site, $data);
      }
    }

// ------------------------------------------- FORM DATA ------------------------------------------ //
    private function process_transaction1()
    {
      /*
      * segment 4 - entry
      * segment 5 - trans_no
      * segment 6 - main_multi_cntr
      * segment 7 - multi_cntr
      */
      $post = $this->input->post();
      $enc_key = $this->encrypt->decode($post['enc_key']);
      // CHECK ENCRYPTED KEY POST DATA TO URI SEGMENT DATA
      $enc_data = explode(';', $enc_key);
      if($enc_data[0] != $this->uri->segment(4) || $enc_data[1] != $this->uri->segment(5) || $enc_data[2] != $this->uri->segment(6)) {
        if(empty($site)) {
          $alert_data = array(
            'title'     => 'ERROR',
            'text'      => 'A TransData Modification Signature has been Detected. Please Contact System Administrator. [ENC-TNO-PRC]',
            'type'      => 'error',
          );
          $this->_alert($alert_data, base_url('dms/documents/process/'.$enc_data[0].'/'.$enc_data[1].'/'.$enc_data[2].'/'.$enc_data[3]));
        }
      }
      $data = array(
        'entry'           => $this->uri->segment(4),
        'trans_no'        => $this->uri->segment(5),
        'main_multi_cntr' => $this->uri->segment(6),
        'multi_cntr'      => $this->uri->segment(7),
      );
      // VERIFY IF TRANSACTION IS INDEED ROUTED TO USER
      $rslt_trans = '';
      $where_trans = array(
        'trans_no'        => $data['trans_no'],
        'receiver_id'     => $this->dmsdata['user_token'],
      );
      // CHECK WHICH TABLE TO LOOK
      if($data['entry'] == 1) {
        if($data['main_multi_cntr'] == 1 && $data['multi_cntr'] == 1) {
          $rslt_trans = $this->Embismodel->selectdata('er_transactions', '*', $where_trans);
        }
      }
      else {
        $where_trans['main_multi_cntr'] = $this->uri->segment(6);
        $where_trans['multi_cntr'] = $this->uri->segment(7);
        $rslt_trans = $this->Embismodel->selectdata('er_transactions_multi', '*', $where_trans);
      }
      // EMPTY RESULT
      if(!$rslt_trans) { $this->_alert('', base_url('dms/documents/inbox'), '[RTE-RES-TRNS]'); }

      // $rslt_trans

      redirect( base_url('dms/documents/inbox'));
    }

// ----------------------------------------------- OLD ----------------------------------

    function index1()
    {
      if(!empty($this->uri->segment(5)))
      {
        $this->load->view('includes/common/header');
        $this->load->view('includes/common/sidebar');
        $this->load->view('includes/common/nav');
        $this->load->view('includes/common/footer');
        $this->load->view('includes/common/dms_styles');

        switch ($this->uri->segment(5)) {
          case 'check_db_connection':
            $this->check_db_connection(); break;
            break;
          case 'doc':
            if(!empty($this->uri->segment(7))) {
              $this->add_transaction(); break;
            }
            else {
        			$this->load->view('Dms/'.$this->uri->segment(6), $this->dmsdata);
            }
            break;

          case 'denr':
            if($this->uri->segment(6) == 'alltrans')
            {
              $this->all_transactions(); break;
            }
            break;

          case 'planning':
      			$this->load->view('Dms/Planning/'.$this->uri->segment(6), $this->dmsdata);
            break;

          case 'settings':
            if($this->uri->segment(6) == 'options')
            {
              $this->settings_options($this->uri->segment(6)); break;
            }
            break;

          default:
            // code...
            break;
        }
      }
    }

    private function check_db_connection()
    {
      $this->load->dbutil(); // LOAD DB UTILITY
      if ($this->dbutil->database_exists('database_name')) {
          // some code...
      }
      $result = $this->dbutil->optimize_table('table_name');
      if ($result !== FALSE) {
          print_r($result);
      }
      if ($this->dbutil->repair_table('table_name')) {
          echo 'Success!';
      }
      $query = $this->db->query("SELECT * FROM mytable");
      $delimiter = ",";
      $newline = "\r\n";
      $enclosure = '"';
      echo $this->dbutil->csv_from_result($query, $delimiter, $newline, $enclosure); // NEEDS FILE HELPER
    }

    private function settings_options($page)
    {
      $this->dmsdata['system'] = $this->Embismodel->selectdata('er_systems', '', '', $this->db->order_by('system_order', 'asc'));
      $this->dmsdata['sub_system'] = $this->Embismodel->selectdata('er_type', '', array('sys_show' => 0));
      $this->load->view('Dms/Settings/'.$page, $this->dmsdata);
      // CUSTOM SETTINGS VIEW
      $this->load->view('Dms/Settings/settings_modal');
      $this->load->view('Dms/Settings/custom_foot');
    }

    function settings_system()
    {
      $loop_success = 0;
      $post_data = $this->input->post();

      switch ($post_data['modal_id']) {
        case 1: // SYSTEMS (ER_SYSTEMS)
          $max_id = $this->Embismodel->selectdata('er_systems', 'MAX(id) max_id', '')[0]['max_id'];
          foreach ($post_data['name'] as $key => $name) {
            if(!empty($name))
            {
              $er_system['ins'] = array(
                'id'           => !empty($max_id) ? $max_id+1 : 1,
                'system_code'  => $post_data['system_code'][$key],
                'name'         => $name,
                'system_order' => !empty($max_id) ? $max_id+1 : 1,
              );
              $er_system['data'] = $this->Embismodel->insertdata('er_systems', $er_system['ins']);
              $result = ($er_system['data']) ? true : false;
            }
          }
          break;
        case 2: // SUB SYSTEMS (ER_TYPE)
          $max_id = $this->Embismodel->selectdata('er_type', 'MAX(id) max_id', '')[0]['max_id'];
          foreach ($post_data['name'] as $key => $name) {
            if(!empty($name) && !empty($post_data['sysid']))
            {
              $er_subsystem['ins'] = array(
                'id'      => !empty($max_id) ? $max_id+1 : 1,
                'name'    => $name,
                'header'  => $post_data['header'][$key],
                'sysid'   => $post_data['sysid'],
                'ssysid'  => $post_data['ssysid'][$key],
              );
              $er_subsystem['data'] = $this->Embismodel->insertdata('er_type', $er_subsystem['ins']);
              $result = ($er_subsystem['data']) ? true : false;
            }
          }
          break;

        default:
          // code...
          break;
      }

      if($result)
      {
        $alert_data = array(
          'title'     => 'Success',
          'text'      => 'Successfully Added New System Data.',
          'type'      => 'success',
        );
        $this->session->set_flashdata('swal_alert_data', $alert_data);
      }
      else {
        $alert_data = array(
          'title'     => 'Error',
          'text'      => 'An error occurred when adding New System Data.',
          'type'      => 'error',
        );
        $this->session->set_flashdata('swal_alert_data', $alert_data);
      }
      redirect(base_url('dms/custom/test/debug/settings/options'));
    }

    function _dms_view($content)
  	{
      $this->session->set_userdata( 'trans_session', '' );

      $this->session->set_userdata( 'current_dms_tab', $content );


  		if ( ! empty($content)) {
  			$this->load->view('Dms/'.$content, $this->dmsdata);
      }
      $this->load->view('Dms/func/modals');
  	}

    function _dms_update($content)
  	{
      if ( ! $this->session->userdata('trans_session')) {
        redirect(base_url('Dms/Dms/all_transactions'));
      }
      else {
        $et_where = array( 'et.trans_no'   => $this->session->userdata('trans_session') );
        $trans_check = $this->Embismodel->selectdata('er_transactions AS et', '', $et_where);

        if(empty($trans_check[0]['trans_no']))
        {
          redirect(base_url('Dms/Dms/all_transactions'));
        }
        else {
          $this->load->view('includes/common/header');
          $this->load->view('includes/common/sidebar');
          $this->load->view('includes/common/nav');
          $this->load->view('includes/common/footer');
          $this->load->view('includes/common/dms_styles');
          if($this->dmsdata['user_token'] == '515e12d4a186a84' || $this->dmsdata['user_token'] == '1255e154af92caff')
          {
            $this->load->view('Dms/include/custom_js.php');
          }

      		if ( ! empty($content)) {
      			$this->load->view($content, $this->dmsdata);
          }

          $this->load->view('Dms/func/modals');
          $this->load->view('Dms/func/route_modals');
          if($this->dmsdata['user_token'] == '515e12d4a186a84' || $this->dmsdata['user_token'] == '1255e154af92caff')
          {
            $this->load->view('Dms/func/modals1');
          }
        }
      }
  	}

    function _dms_update2($content)
  	{
      if ( ! $this->session->userdata('trans_session')) {
        redirect(base_url('Dms/Dms/all_transactions'));
      }
      else {
        $et_where = array( 'et.trans_no'   => $this->session->userdata('trans_session') );
        $trans_check = $this->Embismodel->selectdata('er_transactions AS et', '', $et_where);

        if(empty($trans_check[0]['trans_no']))
        {
          redirect(base_url('Dms/Dms/all_transactions'));
        }
        else {
          if($this->dmsdata['user_token'] == '515e12d4a186a84' || $this->dmsdata['user_token'] == '1255e154af92caff')
          {
            $this->load->view('Dms/include/custom_js.php');
          }

      		if ( ! empty($content)) {
      			$this->load->view($content, $this->dmsdata);
          }

          $this->load->view('Dms/func/modals');
          $this->load->view('Dms/func/route_modals');
          if($this->dmsdata['user_token'] == '515e12d4a186a84' || $this->dmsdata['user_token'] == '1255e154af92caff')
          {
            $this->load->view('Dms/func/modals1');
          }
        }
      }
  	}

    function set_trans_session()
    {
      $this->session->set_userdata( 'trans_session', $this->input->post('trans_no') );
      $this->session->set_userdata( 'main_multi_cntr', '' );
      $this->session->set_userdata( 'multi_cntr', 1 );
    }

    function m_set_trans_session()
    {
      $this->session->set_userdata( 'trans_session', $this->input->post('trans_no') );

      $main_multi_cntr = !empty($this->input->post('main_multi_cntr')) ? $this->input->post('main_multi_cntr') : '';
      $this->session->set_userdata( 'main_multi_cntr', $main_multi_cntr );

      $multi_cntr = !empty($this->input->post('multi_cntr')) ? $this->input->post('multi_cntr') : 1;
      $this->session->set_userdata( 'multi_cntr', $multi_cntr );
    }

    function all_transactions1()
    {
      $this->dmsdata['region'] = $this->Embismodel->selectdata('acc_region AS ar', '', '');
      $this->_dms_view('all_transactions1');
    }

    function drafts()
    {
      $this->_dms_view('drafts');
    }

    function closed()
    {
      $this->_dms_view('closed');
    }

    function records()
    {
      $this->_dms_view('records');
    }

    function claim()
    {
      $this->_dms_view('claim');
    }

    function revisions()
    {
      $this->_dms_view('revisions');
    }

    function dar()
    {
      $this->_dms_view('dar');
    }

    function charts()
    {
      $this->_dms_view('charts');
    }

    function dttb_sample()
    {
      $this->_dms_view('dttb_sample');
    }

    function pab_view()
    {
      $this->_dms_view('pab_view');
    }

    function rec_publish()
    {
      $this->_dms_view('rec_publish');
    }

    function publish_mc()
    {
      $this->_dms_view('publish_mc');
    }

    function publish_so()
    {
      $this->_dms_view('publish_so');
    }

    function publish_dao()
    {
      $this->_dms_view('publish_dao');
    }

    function deleted_trans()
    {
      $this->_dms_view('deleted_trans');
    }

    function confidential()
    {
      $this->_dms_view('confidential');
    }

    function denr_trans()
    {
      $this->_dms_view('denr_trans');
    }

    function add_trans_company()
    {
      $this->dmsdata['region'] = $this->Embismodel->selectdata('acc_region AS ar', '', '');
      $this->load->view('Dms/func/add_trans_company', $this->dmsdata);
    }

    function tracker()
    {
      $this->dmsdata['region'] = $this->Embismodel->selectdata('acc_region AS ar', '', '');
      $this->dmsdata['system'] = $this->Embismodel->selectdata('er_systems AS esy', '', '', $this->db->order_by('esy.system_order', 'asc'));
      $this->dmsdata['status'] = $this->Embismodel->selectdata('er_status AS est', '', '', $this->db->order_by('est.status_order', 'asc'));
      $where['company'] = array('dc.deleted' => 0, );
      $this->dmsdata['company_list'] = $this->Embismodel->selectdata('dms_company AS dc', 'emb_id, company_id, company_name, establishment_name, token', $where['company'], $this->db->order_by('dc.company_name', 'asc'));
      $this->_dms_view('tracker');
    }

    private function add_transaction()
    {
      echo
      $this->dmsdata['trans_session'] = $this->session->userdata('trans_session');

      // $this->dmsdata['region'] = $this->Embismodel->selectdata('acc_region AS ar', '', '');
      // $this->dmsdata['system'] = $this->Embismodel->selectdata('er_systems AS esy', '', '', $this->db->order_by('esy.system_order', 'asc'));
      // $this->dmsdata['status'] = $this->Embismodel->selectdata('er_status AS est', '', '', $this->db->order_by('est.status_order', 'asc'));
      // $where['company'] = array('dc.deleted' => 0, );
      // $this->dmsdata['company_list'] = $this->Embismodel->selectdata('dms_company AS dc', 'emb_id, company_id, company_name, establishment_name, token', $where['company'], $this->db->order_by('dc.company_name', 'asc'));
      // $this->dmsdata['action'] = $this->Embismodel->selectdata('er_action AS ea', '', '');
      //
      // $trans_where = array( 'et.trans_no' => $this->dmsdata['trans_session']);
      // $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions AS et', '', $trans_where);
      //
      // $accred_where = array('ac.token' => $this->dmsdata['user_token'] );
      // $this->dmsdata['credentials'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $accred_where);
      //
      // $afunc_where = array('af.userid' => $this->dmsdata['credentials'][0]['userid'], 'af.stat' => 1 );
      // $this->dmsdata['function'] = $this->Embismodel->selectdata('acc_function AS af', '', $afunc_where);
      //
      // $route_order = ($this->dmsdata['trans_data'][0]['route_order'] == 0) ? 1 : $this->dmsdata['trans_data'][0]['route_order'];
      // $ea_where = array(
      //   'ea.trans_no'     => $this->dmsdata['trans_session'],
      //   'ea.route_order'  => $route_order,
      //   'ea.deleted'      => 0,
      // );
      // $this->dmsdata['attachments'] = $this->Embismodel->selectdata('er_attachments AS ea', '', $ea_where);
      //
      // $this->dmsdata['courier_type'] = $this->Embismodel->selectdata('er_courier AS ec', '', '');
      //
      // $this->assigned_slctn();

      $this->validate_form('Dms/func/add_transaction');
    }

    function update_transaction()
    {
      $this->dmsdata['trans_session'] = $this->session->userdata('trans_session');
      // echo 'debug';
      $this->dmsdata['region'] = $this->Embismodel->selectdata('acc_region AS ar', '', '');
      $this->dmsdata['system'] = $this->Embismodel->selectdata('er_systems AS esy', '', '', $this->db->order_by('esy.system_order', 'asc'));
      $this->dmsdata['status'] = $this->Embismodel->selectdata('er_status AS est', '', '', $this->db->order_by('est.status_order', 'asc'));
      $where['company'] = array('dc.deleted' => 0, );
      $this->dmsdata['company_list'] = $this->Embismodel->selectdata('dms_company AS dc', 'emb_id, company_id, company_name, establishment_name, token', $where['company']);
      $this->dmsdata['action'] = $this->Embismodel->selectdata('er_action AS ea', '', '');

      $accred_where = array('ac.token' => $this->dmsdata['user_token']);
      $this->dmsdata['credentials'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $accred_where);

      $afunc_where = array('af.userid' => $this->dmsdata['credentials'][0]['userid'], 'af.stat' => 1 );
      $this->dmsdata['function'] = $this->Embismodel->selectdata('acc_function AS af', '', $afunc_where);

      $this->assigned_slctn();

      $trans_where = array( 'et.trans_no' => $this->dmsdata['trans_session'] );
      $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions AS et', '', $trans_where);

      $this->dmsdata['trans_cred'] = '';
      // if(!empty($this->dmsdata['trans_data'][0]['receiver_section']))
      // {
        $cred_where = array(
          'ac.region'   => $this->dmsdata['trans_data'][0]['region'],
          'ac.divno'    => $this->dmsdata['trans_data'][0]['receiver_division'],
          'ac.secno'    => ($this->dmsdata['trans_data'][0]['receiver_section'] != 0) ? $this->dmsdata['trans_data'][0]['receiver_section'] : '',
          'ac.verified' => 1
        );
        $this->dmsdata['trans_cred'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $cred_where);
      // }
      //
      $sec_where = array( 'axs.divno' => $this->dmsdata['trans_data'][0]['receiver_division'] );
      $this->dmsdata['section'] = $this->Embismodel->selectdata('acc_xsect AS axs', '', $sec_where);

      $dcomp_where = array( 'dcd.token' => $this->dmsdata['trans_data'][0]['company_token'] );
      $this->dmsdata['company_details'] = $this->Embismodel->selectdata('dms_company AS dcd', '', $dcomp_where);

      $route_order = ($this->dmsdata['trans_data'][0]['route_order'] == 0) ? 1 : $this->dmsdata['trans_data'][0]['route_order'];
      $ea_where = array(
        'ea.trans_no'     => $this->dmsdata['trans_session'],
        'ea.route_order'  => $route_order,
        'ea.deleted'      => 0,
      );
      $this->dmsdata['attachments'] = $this->Embismodel->selectdata('er_attachments AS ea', '', $ea_where);

      $type_vars = array(
        'where' => array(
          'et.sysid'    => $this->dmsdata['trans_data'][0]['system'],
          'et.sys_show' => 0,
        ),
        'order' => $this->db->order_by('et.sysid asc, et.ssysid asc, et.header desc')
      );
      $this->dmsdata['trans_type'] = $this->Embismodel->selectdata('er_type AS et', '', $type_vars['where'], $type_vars['order']);

      $this->dmsdata['courier_type'] = $this->Embismodel->selectdata('er_courier AS ec', '', '');

      $this->add_inputs();

      $this->validate_form('Dms/func/input_transaction');
      // echo 'debug';
    }

    function revise_transaction()
    {
      $this->dmsdata['trans_session'] = $this->session->userdata('trans_session');

      $this->dmsdata['region'] = $this->Embismodel->selectdata('acc_region AS ar', '', '');
      $this->dmsdata['system'] = $this->Embismodel->selectdata('er_systems AS esy', '', '', $this->db->order_by('esy.system_order', 'asc'));
      $this->dmsdata['status'] = $this->Embismodel->selectdata('er_status AS est', '', '');
      $where['company'] = array('dc.deleted' => 0, );
      $this->dmsdata['company_list'] = $this->Embismodel->selectdata('dms_company AS dc', 'emb_id, company_id, company_name, establishment_name, token', $where['company']);
      $this->dmsdata['action'] = $this->Embismodel->selectdata('er_action AS ea', '', '');

      $accred_where = array('ac.token' => $this->dmsdata['user_token']);
      $this->dmsdata['credentials'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $accred_where);

      $afunc_where = array('af.userid' => $this->dmsdata['credentials'][0]['userid'], 'af.stat' => 1 );
      $this->dmsdata['function'] = $this->Embismodel->selectdata('acc_function AS af', '', $afunc_where);

      $this->assigned_slctn();

      $trans_where = array( 'et.trans_no' => $this->dmsdata['trans_session'] );
      $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions AS et', '', $trans_where);

      $this->dmsdata['trans_cred'] = '';
      // if(!empty($this->dmsdata['trans_data'][0]['receiver_section']))
      // {
        $cred_where = array(
          'ac.region'   => $this->dmsdata['trans_data'][0]['region'],
          'ac.divno'    => $this->dmsdata['trans_data'][0]['receiver_division'],
          'ac.secno'    => ($this->dmsdata['trans_data'][0]['receiver_section'] != 0) ? $this->dmsdata['trans_data'][0]['receiver_section'] : '',
          'ac.verified' => 1,
        );
        $this->dmsdata['trans_cred'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $cred_where);
      // }

      $sec_where = array( 'axs.divno' => $this->dmsdata['trans_data'][0]['receiver_division'] );
      $this->dmsdata['section'] = $this->Embismodel->selectdata('acc_xsect AS axs', '', $sec_where);

      $dcomp_where = array( 'dcd.token' => $this->dmsdata['trans_data'][0]['company_token'] );
      $this->dmsdata['company_details'] = $this->Embismodel->selectdata('dms_company AS dcd', '', $dcomp_where);

      $route_order = ($this->dmsdata['trans_data'][0]['route_order'] == 0) ? 1 : $this->dmsdata['trans_data'][0]['route_order'];
      $ea_where = array(
        'ea.trans_no'     => $this->dmsdata['trans_session'],
        'ea.route_order'  => $route_order,
        'ea.deleted'      => 0,
      );
      $this->dmsdata['attachments'] = $this->Embismodel->selectdata('er_attachments AS ea', '', $ea_where);

      $type_vars = array(
        'where' => array(
          'et.sysid'    => $this->dmsdata['trans_data'][0]['system'],
          'et.sys_show' => 0,
        ),
        'order' => $this->db->order_by('et.sysid asc, et.ssysid asc, et.header desc')
      );
      $this->dmsdata['trans_type'] = $this->Embismodel->selectdata('er_type AS et', '', $type_vars['where'], $type_vars['order']);

      $this->add_inputs();

      $history_where = array( 'etl.trans_no' => $this->dmsdata['trans_session'] );
      $history_order = $this->db->order_by('etl.route_order', 'desc' );
      $this->dmsdata['trans_history'] = $this->Embismodel->selectdata('er_transactions_log AS etl', '', $history_where, $history_order );


      $ea_where = array( 'eat.trans_no' => $this->dmsdata['trans_session'], 'eat.deleted' => 0, );
      $this->dmsdata['attachment_view'] = $this->Embismodel->selectdata('er_attachments AS eat', '', $ea_where );

      $this->dmsdata['courier_type'] = $this->Embismodel->selectdata('er_courier AS ec', '', '');

      $this->validate_form('Dms/func/revise_transaction');
    }

    function route_transaction123()
    {
      $this->dmsdata['trans_session'] = $this->session->userdata('trans_session');

      $this->dmsdata['region'] = $this->Embismodel->selectdata('acc_region AS ar', '', '');
      $this->dmsdata['system'] = $this->Embismodel->selectdata('er_systems AS esy', '', '', $this->db->order_by('esy.system_order', 'asc'));
      $this->dmsdata['status'] = $this->Embismodel->selectdata('er_status AS est', '', '', $this->db->order_by('est.status_order', 'asc'));
      $where['company'] = array('deleted' => 0, );
      $this->dmsdata['company_list'] = $this->Embismodel->selectdata('dms_company', 'emb_id, company_id, company_name, establishment_name, token', $where['company']);
      $this->dmsdata['action'] = $this->Embismodel->selectdata('er_action AS ea', '', '');

      $trans_where = array( 'et.trans_no' => $this->dmsdata['trans_session'] );
      $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions AS et', '', $trans_where);

      if($this->dmsdata['trans_data'][0]['multiprc'] > 0) {
        $trans_where = array(
          'et.trans_no'     => $this->dmsdata['trans_session'],
          'et.receiver_id'  => $this->dmsdata['user_token'],
        );
        $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions_multi AS et', '', $trans_where);
      }

      $cred_where = array('ac.region' => $this->dmsdata['trans_data'][0]['region'], 'ac.verified' => 1 );
      $this->dmsdata['trans_cred'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $cred_where);

      $accred_where = array('ac.token' => $this->dmsdata['user_token']);
      $this->dmsdata['credentials'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $accred_where);

      $dcomp_where = array( 'dcd.token' => $this->dmsdata['trans_data'][0]['company_token'] );
      $this->dmsdata['company_details'] = $this->Embismodel->selectdata('dms_company AS dcd', '', $dcomp_where);

      $afunc_where = array('af.userid' => $this->dmsdata['credentials'][0]['userid'], 'af.stat' => 1 );
      $this->dmsdata['function'] = $this->Embismodel->selectdata('acc_function AS af', '', $afunc_where);

      $route_order = ($this->dmsdata['trans_data'][0]['route_order'] == 0) ? 1 : $this->dmsdata['trans_data'][0]['route_order'];
      $ea_where = array(
        'ea.trans_no'     => $this->dmsdata['trans_session'],
        'ea.route_order'  => $route_order+1,
        'ea.deleted'      => 0,
      );
      $this->dmsdata['attachments'] = $this->Embismodel->selectdata('er_attachments AS ea', '', $ea_where);

      $this->assigned_slctn();

      $type_vars = array(
        'where' => array(
          'et.sysid'    => $this->dmsdata['trans_data'][0]['system'],
          // 'et.sys_show' => 0, // uncommented since for pab(old subs of other system) to be viewable
        ),
        'order' => $this->db->order_by('et.sysid asc, et.ssysid asc, et.header desc')
      );
      $this->dmsdata['trans_type'] = $this->Embismodel->selectdata('er_type AS et', '', $type_vars['where'], $type_vars['order']);

      $this->add_inputs();

      // query of transaction's log
      $history_where = array(
        'etl.trans_no'          => $this->dmsdata['trans_session'],
        'etl.main_multi_cntr'   => '',
       );
      $history_order = $this->db->order_by('etl.main_route_order ASC, etl.route_order ASC, etl.multi_cntr ASC');
      $this->dmsdata['trans_history'] = $this->Embismodel->selectdata('er_transactions_log AS etl', '', $history_where, $history_order );

      $where['inthread'] = $this->db->where('etl.trans_no = "'.$this->dmsdata['trans_session'].'" AND ( etl.sender_id = "'.$this->dmsdata['user_token'].'" OR etl.receiver_id =  "'.$this->dmsdata['user_token'].'" )');
      $this->dmsdata['prnl_inthread'] = $this->Embismodel->selectdata('er_transactions_log AS etl', '', '', $where['inthread'] );

      // query of attachments
      foreach ($this->dmsdata['trans_history'] as $key => $value) {
        $ea_where = array(
          'eat.trans_no'    => $value['trans_no'],
          'eat.route_order' => $value['route_order'],
          'eat.deleted'     => 0,
        );
        $ea_order = $this->db->order_by('eat.route_order', 'desc');
        $this->dmsdata['attachment_view'][$key] = $this->Embismodel->selectdata('er_attachments AS eat', '', $ea_where, $ea_order );

        $from_name['where'] = array( 'acd.token' => $value['sender_id'], );
        $from_name['cred'] = $this->Embismodel->selectdata('acc_credentials AS acd', '', $from_name['where'] );

        $from_name['axs_where'] = array( 'axs.secno' => $from_name['cred'][0]['secno'] );
        $from_name['sec'] = $this->Embismodel->selectdata('acc_xsect AS axs', '', $from_name['axs_where'] );
        $from_sec = (!empty($from_name['sec'])) ? '|'.$from_name['sec'][0]['secode'] : '';

        $this->dmsdata['from_name'][$key] = !empty($from_name['cred'][0]['division']) ? $from_name['cred'][0]['division'].$from_sec.'-' : '';

        $receiver_name['axd_where'] = array( 'axd.divno' => $value['receiver_divno'], 'axd.office' => 'EMB' );
        $receiver_name['div'] = $this->Embismodel->selectdata('acc_xdvsion AS axd', '', $receiver_name['axd_where'] );
        $receiver_div = (!empty($receiver_name['div'])) ?  $receiver_name['div'][0]['divcode'] : '';

        $receiver_name['axs_where'] = array( 'axs.secno' => $value['receiver_secno'] );
        $receiver_name['sec'] = $this->Embismodel->selectdata('acc_xsect AS axs', '', $receiver_name['axs_where'] );
        $receiver_sec = (!empty($receiver_name['sec'])) ? '|'.$receiver_name['sec'][0]['secode'] : '';

        $this->dmsdata['receiver_name'][$key] = $receiver_div.$receiver_sec.' - ';

        if($value['multiprc'] > 0)
        {
          $where['etml'] = array(
            'etml.trans_no'           => $value['trans_no'],
            'etml.main_route_order'   => $value['route_order'],
            'etml.route_order'        => 1,
            'etml.main_multi_cntr'    => $value['multi_cntr'],
          );
          $this->dmsdata['multitrans_histo'] = $this->Embismodel->selectdata('er_transactions_log AS etml', '', $where['etml'] );
        }
      }

      $this->dmsdata['courier_type'] = $this->Embismodel->selectdata('er_courier AS ec', '', '');

      $this->validate_form('Dms/func/route_transaction');
    }

    function acknowledgeLetter()
    {
      if(empty($this->session->userdata('trans_session'))){
        redirect(base_url('Dms/Dms/notfound'));
      }
      else {
        $this->dmsdata['trans_session'] = $this->session->userdata('trans_session');

        $trans_where = array( 'et.trans_no' => $this->dmsdata['trans_session'] );
        $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions AS et', '', $trans_where);

        // $header_where = array( 'ou.region' =>   $this->dmsdata['trans_data'][0]['region'] );
        $header_where = $this->db->where('ou.region = "'.$this->session->userdata('region').'" AND ou.cnt = (SELECT max(cnt) FROM office_uploads_document_header AS oh WHERE oh.region = "'.$this->session->userdata('region').'")');
        $header = $this->Embismodel->selectdata('office_uploads_document_header AS ou', '', '', $header_where);

        $this->dmsdata['header'] = 'no-header.png';
        if(!empty($header)) {
          $this->dmsdata['header'] = $header[0]['file_name'];
        }

        // $footer_where = array( 'ouf.region' =>   $this->dmsdata['trans_data'][0]['region'] );
        $footer_where = $this->db->where('ouf.region = "'.$this->session->userdata('region').'" AND ouf.cnt = (SELECT max(cnt) FROM office_uploads_document_footer AS of WHERE of.region = "'.$this->session->userdata('region').'")');
        $this->dmsdata['footer'] = $this->Embismodel->selectdata('office_uploads_document_footer AS ouf', '', '', $footer_where);

        $translog_where = array(
          'etl.trans_no'    => $this->dmsdata['trans_session'],
          'etl.route_order' => 1
        );
        $this->dmsdata['trans_log'] = $this->Embismodel->selectdata('er_transactions_log AS etl', '', $translog_where);

        if($this->dmsdata['trans_data'][0]['route_order'] != 0) {
          $this->load->view('Dms/func/ackno_letter', $this->dmsdata);
        }
        else {
           redirect(base_url('Dms/Dms/notfound'));
        }
      }
    }

    function dispositionForm()
    {
      if(empty($this->session->userdata('trans_session'))){
        redirect(base_url('Dms/Dms/notfound'));
      }
      else {
        $this->dmsdata['trans_session'] = $this->session->userdata('trans_session');

        $trans_where = array( 'et.trans_no' => $this->dmsdata['trans_session'] );
        $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions AS et', '', $trans_where);

        // $translog_where = array(
        //   'etl.trans_no'    => $this->dmsdata['trans_session']
        // );

        // $this->dmsdata['trans_log'] = $this->Embismodel->selectdata('er_transactions_log AS etl', '', $translog_where );

        // $header_where = array( 'ou.region' =>   $this->dmsdata['trans_data'][0]['region'] );
        $header_where = $this->db->where('ou.region = "'.$this->session->userdata('region').'" AND ou.cnt = (SELECT max(cnt) FROM office_uploads_document_header AS oh WHERE oh.region = "'.$this->session->userdata('region').'")');
        $header = $this->Embismodel->selectdata('office_uploads_document_header AS ou', '','', $header_where);

        $this->dmsdata['header'] = 'no-header.png';
        if(!empty($header)) {
          $this->dmsdata['header'] = $header[0]['file_name'];
        }

        $this->dmsdata['trans_log'] = $this->db->query('SELECT * FROM er_transactions_log AS etl WHERE etl.trans_no = '.$this->dmsdata['trans_session'].' AND (etl.receiver_id != "" OR etl.type = 84)')->result_array();

        if($this->dmsdata['trans_data'][0]['route_order'] != 0) {
          $this->load->view('Dms/func/dispo_form', $this->dmsdata);
        }
        else {
           redirect(base_url('Dms/Dms/notfound'));
        }
      }
    }

    function dispositionFormBlank()
    {
      if(empty($this->session->userdata('trans_session'))){
        redirect(base_url('Dms/Dms/notfound'));
      }
      else {
        $this->dmsdata['trans_session'] = $this->session->userdata('trans_session');

        $trans_where = array( 'et.trans_no' => $this->dmsdata['trans_session'] );
        $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions AS et', '', $trans_where);

        $this->dmsdata['trans_log'] = $this->db->query('SELECT * FROM er_transactions_log AS etl WHERE etl.trans_no = '.$this->dmsdata['trans_session'].' AND (etl.receiver_id != "" OR etl.type = 84)')->result_array();

        // $header_where = array( 'ou.region' => $this->dmsdata['trans_data'][0]['region'] );
        $header_where = $this->db->where('ou.region = "'.$this->session->userdata('region').'" AND ou.cnt = (SELECT max(cnt) FROM office_uploads_document_header AS oh WHERE oh.region = "'.$this->session->userdata('region').'")');
        $header = $this->Embismodel->selectdata('office_uploads_document_header AS ou', '', '', $header_where);

        $this->dmsdata['header'] = 'no-header.png';
        if(!empty($header)) {
          $this->dmsdata['header'] = $header[0]['file_name'];
        }

        if($this->dmsdata['trans_data'][0]['route_order'] != 0) {
          $this->load->view('Dms/func/dispo_form_blank', $this->dmsdata);
        }
        else {
           redirect(base_url('Dms/Dms/notfound'));
        }
      }
    }

    // ===========================================        DB STATEMENT FUNCTIONS           =================================================== //

    function validate_form1($site)
    {
      if(isset($_POST['process_transaction']))
      {
        $this->form_validation->set_error_delimiters(' <span class="set_error">', '</span>');

        $this->form_validation->set_rules('system', '', 'required');
        $this->form_validation->set_rules('type', '', 'required');
        $this->form_validation->set_rules('subject', '', 'required');
        $this->form_validation->set_rules('status', '', 'required');
        $this->form_validation->set_rules('company', '', 'required');

        if (empty(($this->input->post('asgnto_multiple'))))
        {
          if(!in_array($this->input->post('status'), array('17', '18', '19', '24', '27'))) // END STATUS
          {
            $this->form_validation->set_rules('division', '', 'required');
            $this->form_validation->set_rules('section', '', 'required');
            $this->form_validation->set_rules('receiver', '', 'required');
          }
        }

        $this->form_validation->set_rules('action', '', 'required');

        // FIRST TRANSACTION ROUTE
        if($this->dmsdata['trans_data'][0]['route_order'] == 0) {
          $this->form_validation->set_rules('attachment', '', 'callback_attachment_exists');
        }

        // TRANSACTION STATUS "FOR FILING / CLOSED"
        if($this->input->post('status') == 24)
        {
          // RECORDS SECTION
          if($this->dmsdata['user_func']['secno'] == '77')
          {
            $this->form_validation->set_rules('records_location', '', 'required');
          }
          $this->form_validation->set_rules('attachment', '', 'callback_attachment_exists');
        }
        // SENT VIA COURIER
        if($this->input->post('status') == '19') {
          $this->form_validation->set_rules('courier_type', '', 'required_courier');
        }

        $this->form_validation->set_message('required', '( required )' );
        $this->form_validation->set_message('attachment_exists', '( required )' );
        $this->form_validation->set_message('required_courier', '( For "Sent Via Courier", Courier Type is Required )' );

        if($this->form_validation->run() == FALSE)
        {
          // $this->_dms_update($site);
          $this->_dms_update2($site);
        }
        else {
          $this->process_transaction();
        }
      }
      else if(isset($_POST['save_draft']))
      {
        $this->save_draft();
      }
      else {
        $this->_dms_update2($site);
      }
    }

    function create_transaction()
    {
      $region_where = array('ar.rgnnum' => $this->dmsdata['user_region'] );
      $region_data = $this->Embismodel->selectdata('acc_region AS ar', '', $region_where );

      $where['crte_trns'] = array( 'region' => $this->dmsdata['user_region'] );
      $new_transaction = $this->Embismodel->selectdata( 'er_transactions AS et', 'MAX(et.trans_no) AS max_trans_no', $where['crte_trns'] );

      $current_yr = date("Y");
      $trans_rgn = $region_data[0]['rgnid'] * 1000000;

      // creation of transaction ID
      if(sizeof($new_transaction) != 0) {
        $max_id = $new_transaction[0]['max_trans_no'];

        $transaction_yr = intval($max_id / 100000000);

        if($transaction_yr == $current_yr) {
          $trans_no = $max_id + 1;
        }
        else {
          $trans_no = ($current_yr * 100000000) + $trans_rgn + 1;
        }
      }
      else {
        $trans_no = ($current_yr * 100000000) + $trans_rgn + 1;
      }

      // creation of transaction token
      $trans_token = $this->dmsdata['user_region'].'-'.$current_yr.'-'.sprintf('%06d', fmod($trans_no, 1000000));

      $date_in = date('Y-m-d H:i:s');

      $acwhere = array('ac.token' => $this->dmsdata['user_token'] );
      $credq = $this->Embismodel->selectdata('acc_credentials AS ac', '', $acwhere );

      $mname = ' ';
      if(!empty($credq[0]['mname']) )
        $mname = ' '.$credq[0]['mname'][0].'. ';

      $suffix = '';
      if(!empty($credq[0]['suffix']) )
        $suffix = ' '.$credq[0]['suffix'];

      $sender_name = ucwords($credq[0]['fname'].$mname.$credq[0]['sname']).$suffix;

      $ins_translog = array(
        'trans_no'        => $trans_no,
        'route_order'     => 1,
        'sender_divno'    => $this->dmsdata['user_func']['divno'],
        'sender_secno'    => $this->dmsdata['user_func']['secno'],
        'sender_id'       => $this->dmsdata['user_token'],
        'sender_name'     => $sender_name,
        'sender_ipadress' => $this->input->ip_address(),
        'sender_region'   => $this->dmsdata['user_region'],
        'date_in'         => $date_in,
      );
      $this->Embismodel->insertdata('er_transactions_log', $ins_translog);

      $start_date = date('Y-m-d');

      $ins_trans = array(
        'trans_no'    => $trans_no,
        'token'       => $trans_token,
        'region'      => $this->dmsdata['user_region'],
        'sender_id'   => $this->dmsdata['user_token'],
        'start_date'  => $start_date,
      );
      $this->Embismodel->insertdata('er_transactions', $ins_trans);

      $this->session->set_userdata( 'trans_session', $trans_no );
      $this->session->set_userdata( 'main_multi_cntr', '' );

      redirect(base_url('Dms/Dms/add_transaction'));
    }

    function save_draft()
    {
      $data = array(
        'user_token'    => $this->dmsdata['user_token'],
        'user_region'   => $this->dmsdata['user_region'],
        'trans_session' => $this->session->userdata('trans_session'),
        'start_date'    => date('Y-m-d'),
        'post_data'     => $this->input->post(),
      );

      $where['trans'] = array('et.trans_no' => $data['trans_session']);
      $data['trnsctn'] = $this->Embismodel->selectdata('er_transactions AS et', '', $where['trans'] );

      $where['comp'] = array('dc.token' => $data['post_data']['company'] );
      $data['company'] = $this->Embismodel->selectdata('dms_company AS dc', '', $where['comp'] );

      $where['type'] = array('et.id' => $data['post_data']['type'] );
      $data['type'] = $this->Embismodel->selectdata('er_type AS et', '', $where['type'] );

      $where['status'] = array('es.id' => $data['post_data']['status'] );
      $data['status'] = $this->Embismodel->selectdata('er_status AS es', '', $where['status'] );

      $where['cred_snder'] = array('ac.token' => $data['user_token'] );
      $data['cred_snder'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $where['cred_snder'] );

      $snder_mname = (!empty($data['cred_snder'][0]['mname'])) ? ' '.$data['cred_snder'][0]['mname'][0].'. ' : ' ';
      $snder_suffix = (!empty($data['cred_snder'][0]['suffix'])) ? ' '.$data['cred_snder'][0]['suffix'] : '';
      $data['snder'] = $data['cred_snder'][0]['fname'].$snder_mname.$data['cred_snder'][0]['sname'].$snder_suffix;

      $where['cred_rcver'] = array('ac.token' => $data['post_data']['receiver'] );
      $data['cred_rcver'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $where['cred_rcver'] );

      $rcver_mname = (!empty($data['cred_rcver'][0]['mname']) ) ? ' '.$data['cred_rcver'][0]['mname'][0].'. ' : ' ';
      $rcver_suffix = (!empty($data['cred_rcver'][0]['suffix']) ) ? ' '.$data['cred_rcver'][0]['suffix'] : '';
      $data['rcver'] = $data['cred_rcver'][0]['fname'].$rcver_mname.$data['cred_rcver'][0]['sname'].$rcver_suffix;

      $rcvr_func['data'] = array(
        'divno' => '',
        'secno' => '',
      );
      if(!empty($data['post_data']['receiver']))
      {
        $rcvr_func['where'] = array('afn.userid' => $data['cred_rcver'][0]['userid'], 'afn.stat' => 1 );
        $rcvr_func['result'] = $this->Embismodel->selectdata( 'acc_function AS afn', '',  $rcvr_func['where'] );
        if(!empty($rcvr_func['result']))
        {
          $rcvr_func['data'] = array(
            'divno' => $rcvr_func['result'][0]['divno'],
            'secno' => $rcvr_func['result'][0]['secno'],
          );
        }
      }

      $trans_vars = array(
        'table' => 'er_transactions AS et',
        'set'   => array(
          'et.company_token'      => (!empty($data['post_data']['company'])) ? $data['post_data']['company'] : $data['trnsctn'][0]['company_token'],
          'et.company_name'       => (!empty($data['company'][0]['company_name'])) ? $data['company'][0]['company_name'] : $data['trnsctn'][0]['company_name'],
          'et.emb_id'             => (!empty($data['company'][0]['emb_id'])) ? $data['company'][0]['emb_id'] : $data['trnsctn'][0]['emb_id'],
          'et.subject'            => (!empty($data['post_data']['subject'])) ? $data['post_data']['subject'] : $data['trnsctn'][0]['subject'],
          'et.system'             => (!empty($data['post_data']['system'])) ? $data['post_data']['system'] : $data['trnsctn'][0]['system'],
          'et.type'               => (!empty($data['post_data']['type'])) ? $data['post_data']['type'] : $data['trnsctn'][0]['type'],
          'et.type_description'   => (!empty($data['type'][0]['name'])) ? $data['type'][0]['name'] : $data['trnsctn'][0]['type_description'],
          'et.step'               => 0,
          'et.status'             => (!empty($data['post_data']['status'])) ? $data['post_data']['status'] : $data['trnsctn'][0]['status'],
          'et.status_description' => (!empty($data['status'][0]['name'])) ? $data['status'][0]['name'] : $data['trnsctn'][0]['status_description'],
          'et.receive'            => 0,
          // 'et.sender_id'          => $data['user_token'],
          // 'et.sender_name'        => $data['snder'],
          'et.receiver_division'  => $data['post_data']['division'],
          'et.receiver_section'   => $data['post_data']['section'],
          'et.receiver_region'    => $data['cred_rcver'][0]['region'],
          'et.receiver_id'        => $data['post_data']['receiver'],
          'et.receiver_name'      => $data['rcver'],
          'et.action_taken'       => $data['post_data']['action'],
          'et.remarks'            => $data['post_data']['remarks'],
          'et.start_date'         => $data['start_date'],
          'et.tag_doc_type'       => !empty($data['post_data']['tag_doc_type']) ? $data['post_data']['tag_doc_type'] : 0,
        ),
        'where' => array(
          'et.trans_no'           => $data['trans_session'],
        ),
      );
      $result = $this->Embismodel->updatedata( $trans_vars['set'], $trans_vars['table'], $trans_vars['where'] );

      $translog_vars = array(
        'table' => 'er_transactions_log AS etl',
        'set'   => array(
          'etl.subject'             => $data['post_data']['subject'],
          'etl.receiver_divno'      => $rcvr_func['data']['divno'],
          'etl.receiver_secno'      => $rcvr_func['data']['secno'],
          'etl.receiver_id'         => (!empty($data['post_data']['receiver'])) ? $data['post_data']['receiver'] : 0,
          'etl.receiver_name'       => (!empty($data['rcver'])) ? $data['rcver'] : '--',
          'etl.receiver_region'     => $data['cred_rcver'][0]['region'],
          'etl.type'                => $data['post_data']['type'],
          'etl.status'              => $data['post_data']['status'],
          'etl.status_description'  => $data['status'][0]['name'],
          'etl.action_taken'        => $data['post_data']['action'],
          'etl.remarks'             => $data['post_data']['remarks'],
        ),
        'where' => array(
          'etl.trans_no'            => $data['post_data']['trans_no'],
          'etl.route_order'         => $data['trnsctn'][0]['route_order'],
        ),
      );
      $result = $this->Embismodel->updatedata( $translog_vars['set'], $translog_vars['table'], $translog_vars['where'] );

      // SUBCATEGORIES OF SUBTYPES
      $this->add_inputs_tbdb($data);

      if($result)
      {
        $swal_arr = array(
          'title'     => '<span style="font-weight:bolder">SUCCESS!</span>',
          // 'text'      => 'IIS No. '.$data['trnsctn'][0]['token'].' saved successfully.',
          'text'      => '[IIS Reference No.] '.$data['trnsctn'][0]['token'].'<br />Your Transaction has been Successfully Saved.<br />Thank you!',
          'type'      => 'success',
        );
        $this->session->set_flashdata('swal_arr', $swal_arr);

        $red_url = !empty($this->dmsdata['user_options']['save_draft']) ? $this->dmsdata['user_options']['save_draft'] : 'drafts';
        redirect(base_url('Dms/Dms/drafts'));
      }
    }

    function process_transaction()
    {
      $result = '';
      $data = array(
        'user_token'      => $this->dmsdata['user_token'],
        'user_divno'      => $this->dmsdata['user_func']['divno'],
        'user_secno'      => $this->dmsdata['user_func']['secno'],
        'user_region'     => $this->dmsdata['user_region'],
        'trans_session'   => $this->session->userdata('trans_session'),
        'main_multi_cntr' => !empty($this->session->userdata('main_multi_cntr'))? trim($this->session->userdata('main_multi_cntr')) : '',
        'multi_cntr'      => !empty($this->session->userdata('multi_cntr'))? trim($this->session->userdata('multi_cntr')) : 1,
        'start_date'      => date('Y-m-d'),
        'date_in'         => date('Y-m-d H:i:s'),
        'date_out'        => date('Y-m-d H:i:s'),
        'post_data'       => $this->input->post(),
      );
      // Get this Transaction's Data
      $where['trans'] = array( 'et.trans_no'  => $data['trans_session'] );
      $data['trnsctn'] = $this->Embismodel->selectdata( 'er_transactions AS et', '', $where['trans'] );

      $where['comp'] = array('dc.token' => $data['post_data']['company'] );
      $data['company'] = $this->Embismodel->selectdata('dms_company AS dc', '', $where['comp'] );

      $where['type'] = array('et.id' => $data['post_data']['type'] );
      $data['type'] = $this->Embismodel->selectdata('er_type AS et', '', $where['type'] );

      $where['status'] = array( 'es.id' => $data['post_data']['status'] );
      $data['status'] = $this->Embismodel->selectdata('er_status AS es', '', $where['status'] );

      $where['cred_snder'] = array('ac.token' => $data['user_token'] );
      $data['cred_snder'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $where['cred_snder'] );

      $snder_mname = (!empty($data['cred_snder'][0]['mname'])) ? ' '.$data['cred_snder'][0]['mname'][0].'. ' : ' ';
      $snder_suffix = (!empty($data['cred_snder'][0]['suffix'])) ? ' '.$data['cred_snder'][0]['suffix'] : '';
      $data['snder'] = $data['cred_snder'][0]['fname'].$snder_mname.$data['cred_snder'][0]['sname'].$snder_suffix;

      $where['cred_rcver'] = array('ac.token' => $data['post_data']['receiver'] );
      $data['cred_rcver'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $where['cred_rcver'] );

      $rcver_mname = (!empty($data['cred_rcver'][0]['mname']) ) ? ' '.$data['cred_rcver'][0]['mname'][0].'. ' : ' ';
      $rcver_suffix = (!empty($data['cred_rcver'][0]['suffix']) ) ? ' '.$data['cred_rcver'][0]['suffix'] : '';
      $data['rcver'] = $data['cred_rcver'][0]['fname'].$rcver_mname.$data['cred_rcver'][0]['sname'].$rcver_suffix;

      // APPROVED BY D
      $stat_dsc = ($data['post_data']['status'] == 5 && $data['user_token'] == '25dde3133d1748') ? 'signed by the Director' : $data['status'][0]['name'];



      if(!empty($data['trnsctn'][0]['multiprc']) || !empty($data['main_route_order']))
      {
        // search on er_transactions_multi
        // save to er_transactions_multi
        if(!empty($this->input->post('asgnto_multiple'))) // equal to 'multiple'
        {
          $where['trans'] = array(
            'etm.trans_no'        => $data['trans_session'],
            'etm.main_multi_cntr' => $data['main_multi_cntr'],
            'etm.multi_cntr'      => $data['multi_cntr'],
            'etm.receiver_id'     => $data['user_token'],
          );
          $data['trnsctn'] = $this->Embismodel->selectdata( 'er_transactions_multi AS etm', '', $where['trans'] );

          // Get transaction's log Data
          $where['etlog'] = array(
            'etl.trans_no'         => $data['trans_session'],
            'etl.main_multi_cntr'  => $data['main_multi_cntr'],
            'etl.multi_cntr'       => $data['multi_cntr'],
            // 'etl.receiver_id'      => $data['user_token'],
          );
          $data['etlog'] = $this->Embismodel->selectdata( 'er_transactions_log AS etl', '', $where['etlog'] );

          // Update 1st Inserted Row for One Receiver in transaction_log
          $translog_data = array(
            'set'   => array(
              'multiprc'                => 1,
              'etl.subject'             => $data['post_data']['subject'],
              'etl.sender_divno'        => $data['user_divno'],
              'etl.sender_secno'        => $data['user_secno'],
              'etl.sender_id'           => $data['user_token'],
              'etl.sender_ipadress'     => $this->input->ip_address(),
              'etl.receiver_divno'      => '',
              'etl.receiver_secno'      => '',
              'etl.receiver_id'         => 0,
              'etl.receiver_name'       => '--',
              'etl.receiver_region'     => '',
              'etl.type'                => $data['post_data']['type'],
              'etl.status'              => $data['post_data']['status'],
              'etl.status_description'  => $stat_dsc,
              'etl.action_taken'        => $data['post_data']['action'],
              'etl.remarks'             => $data['post_data']['remarks'],
              'etl.date_out'            => $data['date_out'],
            ),
            'where' => array(
              'etl.trans_no'            => $data['trans_session'],
              'etl.main_route_order'    => $data['trnsctn'][0]['main_route_order'],
              'etl.route_order'         => $data['trnsctn'][0]['route_order']+1,
              'etl.main_multi_cntr'     => $data['trnsctn'][0]['main_multi_cntr'],
              'etl.sender_id'           => $data['user_token'],
            ),
          );
          $res['translog'] = $this->Embismodel->updatedata( $translog_data['set'], 'er_transactions_log AS etl', $translog_data['where'] );
          // $res['translog'] = $this->Embismodel->selectdata( 'er_transactions_log AS etl','', $translog_data['where'] );
          // echo $this->db->last_query(); exit;

          // Get Transaction's Receive DateTime
          $where['etlog_slct'] = array(
            'etl.trans_no'         => $data['trnsctn'][0]['trans_no'],
            'etl.route_order'      => $data['trnsctn'][0]['route_order']+1,
            'etl.main_multi_cntr'  => $data['trnsctn'][0]['main_multi_cntr'],
            'etl.sender_id'        => $data['user_token'],
          );
          $etlog_slct = $this->Embismodel->selectdata('er_transactions_log AS etl', '', $where['etlog_slct']);

          // For every user selected on multiplre routing
          foreach ($data['post_data']['multislct_prsnl'] as $key => $value) {
            $data['multiprsnl'][$key]  = explode(';', $value); // for json post data (multiple personnel data, separated with ";")

            // Insert Rows in transaction_log as per multiple personnels
            $etl_insert = array(
                'trans_no'            => $data['trnsctn'][0]['trans_no'],
                'main_route_order'    => $data['trnsctn'][0]['route_order']+1,
                'route_order'         => 1,
                'multiprc'            => 0,
                'main_multi_cntr'     => (!empty($etlog_slct[0]['main_multi_cntr'])) ? trim($etlog_slct[0]['main_multi_cntr'].'-'.$etlog_slct[0]['multi_cntr']) : trim($etlog_slct[0]['multi_cntr']),
                'multi_cntr'          => $key+1,
                'subject'             => $data['post_data']['subject'],
                'sender_divno'        => $data['user_divno'],
                'sender_secno'        => $data['user_secno'],
                'sender_id'           => $data['user_token'],
                'sender_name'         => $data['snder'],
                'sender_region'       => $data['user_region'],
                'sender_ipadress'     => $this->input->ip_address(),
                'receiver_divno'      => (!empty($data['multiprsnl'][$key][1])) ? $data['multiprsnl'][$key][1] : '',
                'receiver_secno'      => (!empty($data['multiprsnl'][$key][2])) ? $data['multiprsnl'][$key][2] : '',
                'receiver_id'         => (!empty($data['multiprsnl'][$key][3])) ? $data['multiprsnl'][$key][3] : 0,
                'receiver_name'       => (!empty($data['multiprsnl'][$key][4])) ? $data['multiprsnl'][$key][4] : '--',
                'receiver_region'     => (!empty($data['multiprsnl'][$key][0])) ? $data['multiprsnl'][$key][0] : $data['cred_snder'][0]['region'],
                'type'                => $data['post_data']['type'],
                'status'              => $data['post_data']['status'],
                'status_description'  => $stat_dsc,
                'action_taken'        => $data['post_data']['action'],
                'remarks'             => (!empty($data['multiprsnl'][$key][5])) ? $data['multiprsnl'][$key][5] : $data['post_data']['remarks'],
                // 'remarks'             => $data['post_data']['remarks'],
                'date_in'             => (!empty($etlog_slct[0]['date_in'])) ? $etlog_slct[0]['date_in'] : $data['date_in'],
                'date_out'            => $data['date_out'],
            );
            $result = $this->Embismodel->insertdata( 'er_transactions_log', $etl_insert );

            // Insert in transaction_multi (full for multi-user routing)
            $insert['er_trans_multi'] = array (
              'trans_no'            => $data['trnsctn'][0]['trans_no'],
              'token'               => $data['trnsctn'][0]['token'],
              'main_route_order'    => $data['trnsctn'][0]['route_order']+1,
              'route_order'         => 1,
              'multiprc'            => 0,
              'main_multi_cntr'     => (!empty($data['trnsctn'][0]['main_multi_cntr'])) ? trim($data['trnsctn'][0]['main_multi_cntr'].'-'.$data['trnsctn'][0]['multi_cntr']) : trim($data['trnsctn'][0]['multi_cntr']),
              'multi_cntr'          => $key+1,
              'company_token'       => $data['post_data']['company'],
              'company_name'        => $data['company'][0]['company_name'],
              'emb_id'              => $data['company'][0]['emb_id'],
              'subject'             => $data['post_data']['subject'],
              'system'              => $data['post_data']['system'],
              'type'                => $data['post_data']['type'],
              'type_description'    => $data['type'][0]['name'],
              'status'              => $data['post_data']['status'],
              'status_description'  => $stat_dsc,
              'receive'             => 0,
              'sender_id'           => $data['user_token'],
              'sender_name'         => $data['snder'],
              'receiver_division'   => (!empty($data['multiprsnl'][$key][1])) ? $data['multiprsnl'][$key][1] : $data['cred_snder'][0]['divno'],
              'receiver_section'    => $data['multiprsnl'][$key][2],
              'receiver_region'     => (!empty($data['multiprsnl'][$key][0])) ? $data['multiprsnl'][$key][0] : $data['cred_snder'][0]['region'],
              'receiver_id'         => (!empty($data['multiprsnl'][$key][3])) ? $data['multiprsnl'][$key][3] : 0,
              'receiver_name'       => (!empty($data['multiprsnl'][$key][4])) ? $data['multiprsnl'][$key][4] : '--',
              'action_taken'        => $data['post_data']['action'],
              'remarks'             => (!empty($data['multiprsnl'][$key][5])) ? $data['multiprsnl'][$key][5] : $data['post_data']['remarks'],
              // 'remarks'             => $data['post_data']['remarks'],
              'start_date'          => $data['trnsctn'][0]['start_date'],
              'records_location'    => !empty($data['post_data']['records_location']) ? $data['post_data']['records_location'] : '',
              'region'              => $data['trnsctn'][0]['region'],
            );
            $result = $this->Embismodel->insertdata( 'er_transactions_multi', $insert['er_trans_multi'] );

            // Update transaction sets multiprc to 1
            if($result)
            {
              $translog_vars = array(
                'set'   => array(
                  'etm.route_order'        => $data['trnsctn'][0]['route_order']+1,
                  'etm.multiprc'           => 1,
                  'etm.company_token'      => $data['post_data']['company'],
                  'etm.company_name'       => $data['company'][0]['company_name'],
                  'etm.emb_id'             => $data['company'][0]['emb_id'],
                  'etm.subject'            => $data['post_data']['subject'],
                  'etm.system'             => $data['post_data']['system'],
                  'etm.type'               => $data['post_data']['type'],
                  'etm.type_description'   => $data['type'][0]['name'],
                  'etm.status'             => $data['post_data']['status'],
                  'etm.status_description' => $stat_dsc,
                  'etm.receive'            => 0,
                  'etm.receiver_division'  => '',
                  'etm.receiver_section'   => '',
                  'etm.receiver_region'    => '',
                  'etm.receiver_id'        => 0,
                  'etm.receiver_name'      => '--',
                  'etm.action_taken'       => $data['post_data']['action'],
                  'etm.remarks'            => $data['post_data']['remarks'],
                  'etm.records_location'   => !empty($data['post_data']['records_location']) ? $data['post_data']['records_location'] : '',
                ),
                'where' => array(
                  'etm.trans_no'          => $data['trnsctn'][0]['trans_no'],
                  'etm.route_order'       => $data['trnsctn'][0]['route_order'],
                  'etm.main_multi_cntr'   => $data['trnsctn'][0]['main_multi_cntr'],
                  'etm.multi_cntr'        => $data['trnsctn'][0]['multi_cntr'],
                ),
              );
              $result = $this->Embismodel->updatedata( $translog_vars['set'], 'er_transactions_multi AS etm', $translog_vars['where'] );
            }
          }
        }
        else // equal to 0
        {
          $where['etl_ref'] = array(
            'etl_m.trans_no'          => $data['trans_session'],
            // 'etl_m.main_route_order'  => $data['main_route_order'],
            'etl_m.main_multi_cntr'   => $data['main_multi_cntr'],
            'etl_m.multi_cntr'        => $data['multi_cntr'],
            'etl_m.receiver_id'       => $data['user_token'],
          );
          $etl_ref = $this->Embismodel->selectdata('er_transactions_multi AS etl_m', '', $where['etl_ref']);


          // GETTING FUNCTION OF RECEIVER (DIVISION, SECTION)
          $rcvr_func['data'] = array(
            'id'    => 0,
            'divno' => '',
            'secno' => '',
          );
          if(!empty($data['post_data']['receiver']))
          {
            $rcvr_func['where'] = array('afn.userid' => $data['cred_rcver'][0]['userid'], 'afn.stat' => 1 );
            $rcvr_func['result'] = $this->Embismodel->selectdata( 'acc_function AS afn', '',  $rcvr_func['where'] );
            if(!empty($rcvr_func['result']))
            {
              $rcvr_func['data'] = array(
                'id'    => $data['post_data']['receiver'],
                'divno' => $rcvr_func['result'][0]['divno'],
                'secno' => $rcvr_func['result'][0]['secno'],
              );
            }
          }

          // get er_transactions_multi['main_route_order']
          $translog_vars = array(
            'set'   => array(
              'etl.subject'             => $data['post_data']['subject'],
              'etl.sender_ipadress'     => $this->input->ip_address(),
              'etl.receiver_divno'      => $rcvr_func['data']['divno'],
              'etl.receiver_secno'      => $rcvr_func['data']['secno'],
              'etl.receiver_id'         => $rcvr_func['data']['id'],
              'etl.receiver_name'       => (!empty($data['rcver'])) ? $data['rcver'] : '--',
              'etl.receiver_region'     => $data['cred_rcver'][0]['region'],
              'etl.type'                => $data['post_data']['type'],
              'etl.status'              => $data['post_data']['status'],
              'etl.status_description'  => $stat_dsc,
              'etl.action_taken'        => $data['post_data']['action'],
              'etl.remarks'             => $data['post_data']['remarks'],
              'etl.date_out'            => $data['date_out'],
            ),
            'where' => array(
              'etl.trans_no'            => $data['trans_session'],
              'etl.main_route_order'    => $etl_ref[0]['main_route_order'],
              'etl.route_order'         => $etl_ref[0]['route_order']+1,
              'etl.main_multi_cntr'     => $etl_ref[0]['main_multi_cntr'],
              'etl.multi_cntr'          => $etl_ref[0]['multi_cntr'],
              'etl.sender_id'           => $data['user_token'],
            ),
          );
          $result = $this->Embismodel->updatedata( $translog_vars['set'], 'er_transactions_log AS etl', $translog_vars['where'] );

          if($result) {
            $trans_vars = array(
              'table' => '',
              'set'   => array(
                'etm.route_order'        => $etl_ref[0]['route_order']+1,
                'etm.company_token'      => $data['post_data']['company'],
                'etm.company_name'       => $data['company'][0]['company_name'],
                'etm.emb_id'             => $data['company'][0]['emb_id'],
                'etm.subject'            => $data['post_data']['subject'],
                'etm.system'             => $data['post_data']['system'],
                'etm.type'               => $data['post_data']['type'],
                'etm.type_description'   => $data['type'][0]['name'],
                'etm.status'             => $data['post_data']['status'],
                'etm.status_description' => $stat_dsc,
                'etm.receive'            => 0,
                'etm.sender_id'          => $data['user_token'],
                'etm.sender_name'        => $data['snder'],
                'etm.receiver_division'  => (!empty($data['post_data']['division'])) ? $data['post_data']['division'] : $data['cred_snder'][0]['divno'],
                'etm.receiver_section'   => $data['post_data']['section'],
                'etm.receiver_region'    => (!empty($data['cred_rcver'][0]['region'])) ? $data['cred_rcver'][0]['region'] : $data['cred_snder'][0]['region'],
                'etm.receiver_id'        => (!empty($data['post_data']['receiver'])) ? $data['post_data']['receiver'] : 0,
                'etm.receiver_name'      => (!empty($data['rcver'])) ? $data['rcver'] : '--',
                'etm.action_taken'       => $data['post_data']['action'],
                'etm.remarks'            => $data['post_data']['remarks'],
                'etm.records_location'   => !empty($data['post_data']['records_location']) ? $data['post_data']['records_location'] : '',
              ),
              'where' => array(
                'etm.trans_no'            => $data['trans_session'],
                'etm.main_route_order'    => $etl_ref[0]['main_route_order'],
                'etm.route_order'         => $etl_ref[0]['route_order'],
                'etm.main_multi_cntr'     => $etl_ref[0]['main_multi_cntr'],
                'etm.multi_cntr'          => $etl_ref[0]['multi_cntr'],
                'etm.receiver_id'         => $data['user_token'],
              ),
            );
            $result = $this->Embismodel->updatedata( $trans_vars['set'], 'er_transactions_multi AS etm', $trans_vars['where'] );
          }
        }
      }
      else // equal to 0
      {
        if(!empty($this->input->post('asgnto_multiple'))) // equal to 'multiple'
        {
          // Get transaction's log Data
          $where['etlog'] = array(
            'etl.trans_no'         => $data['trans_session'],
            'etl.main_multi_cntr'  => $data['main_multi_cntr'],
          );
          $data['etlog'] = $this->Embismodel->selectdata( 'er_transactions_log AS etl', '', $where['etlog'] );

          // Update 1st Inserted Row for One Receiver in transaction_log
          $translog_data = array(
            'set'   => array(
              'multiprc'                => 1,
              'etl.subject'             => $data['post_data']['subject'],
              'etl.sender_divno'        => $data['user_divno'],
              'etl.sender_secno'        => $data['user_secno'],
              'etl.sender_id'           => $data['user_token'],
              'etl.sender_ipadress'     => $this->input->ip_address(),
              'etl.receiver_divno'      => '',
              'etl.receiver_secno'      => '',
              'etl.receiver_id'         => 0,
              'etl.receiver_name'       => '--',
              'etl.receiver_region'     => '',
              'etl.type'                => $data['post_data']['type'],
              'etl.status'              => $data['post_data']['status'],
              'etl.status_description'  => $stat_dsc,
              'etl.action_taken'        => $data['post_data']['action'],
              'etl.remarks'             => $data['post_data']['remarks'],
              'etl.date_out'            => $data['date_out'],
            ),
            'where' => array(
              'etl.trans_no'            => $data['post_data']['trans_no'],
              'etl.main_route_order'    => '',
              'etl.route_order'         => $data['trnsctn'][0]['route_order']+1,
              'etl.main_multi_cntr'     => '',
              'etl.sender_id'           => $data['user_token'],
            ),
          );
          $res['translog'] = $this->Embismodel->updatedata( $translog_data['set'], 'er_transactions_log AS etl', $translog_data['where'] );

          // Get Transaction's Receive DateTime
          $where['etlog_slct'] = array(
            'etl.trans_no'         => $data['trnsctn'][0]['trans_no'],
            'etl.main_route_order' => '',
            'etl.route_order'      => $data['trnsctn'][0]['route_order']+1,
            'etl.main_multi_cntr'  => '',
            'etl.sender_id'        => $data['user_token'],
          );
          $etlog_slct = $this->Embismodel->selectdata('er_transactions_log AS etl', '', $where['etlog_slct']);

          foreach ($data['post_data']['multislct_prsnl'] as $key => $value) {
            $data['multiprsnl'][$key]  = explode(';', $value); // for json post data (multiple personnel data, separated with ";")

            // Insert Rows in transaction_log as per multiple personnels
            $etl_insert = array(
                'trans_no'            => $data['trnsctn'][0]['trans_no'],
                'main_route_order'    => $etlog_slct[0]['route_order'],
                'route_order'         => 1,
                'multiprc'            => 0,
                'main_multi_cntr'     => (!empty($data['etlog'][0]['main_multi_cntr'])) ? trim($data['etlog'][0]['main_multi_cntr'].'.'.$data['etlog'][0]['multi_cntr']) : trim($data['etlog'][0]['multi_cntr']),
                'multi_cntr'          => $key+1,
                'subject'             => $data['post_data']['subject'],
                'sender_divno'        => $data['user_divno'],
                'sender_secno'        => $data['user_secno'],
                'sender_id'           => $data['user_token'],
                'sender_name'         => $data['snder'],
                'sender_region'       => $data['user_region'],
                'sender_ipadress'     => $this->input->ip_address(),
                'receiver_divno'      => (!empty($data['multiprsnl'][$key][1])) ? $data['multiprsnl'][$key][1] : '',
                'receiver_secno'      => (!empty($data['multiprsnl'][$key][2])) ? $data['multiprsnl'][$key][2] : '',
                'receiver_id'         => (!empty($data['multiprsnl'][$key][3])) ? $data['multiprsnl'][$key][3] : 0,
                'receiver_name'       => (!empty($data['multiprsnl'][$key][4])) ? $data['multiprsnl'][$key][4] : '--',
                'receiver_region'     => (!empty($data['multiprsnl'][$key][0])) ? $data['multiprsnl'][$key][0] : $data['cred_snder'][0]['region'],
                'type'                => $data['post_data']['type'],
                'status'              => $data['post_data']['status'],
                'status_description'  => $stat_dsc,
                'action_taken'        => $data['post_data']['action'],
                'remarks'             => (!empty($data['multiprsnl'][$key][5])) ? $data['multiprsnl'][$key][5] : $data['post_data']['remarks'],
                // 'remarks'             => $data['post_data']['remarks'],
                'date_in'             => (!empty($etlog_slct[0]['date_in'])) ? $etlog_slct[0]['date_in'] : $data['date_in'],
                'date_out'            => $data['date_out'],
            );
            $result = $this->Embismodel->insertdata( 'er_transactions_log', $etl_insert );

            // Insert in transaction_multi (full for multi-user routing)
            $insert['er_trans_multi'] = array (
              'trans_no'            => $data['trnsctn'][0]['trans_no'],
              'token'               => $data['trnsctn'][0]['token'],
              'main_route_order'    => $data['trnsctn'][0]['route_order']+1,
              'route_order'         => 1,
              'multiprc'            => 0,
              'main_multi_cntr'     => (!empty($data['etlog'][0]['main_multi_cntr'])) ? trim($data['etlog'][0]['main_multi_cntr'].'.'.$data['etlog'][0]['multi_cntr']) : trim($data['etlog'][0]['multi_cntr']),
              'multi_cntr'          => $key+1,
              'company_token'       => $data['post_data']['company'],
              'company_name'        => $data['company'][0]['company_name'],
              'emb_id'              => $data['company'][0]['emb_id'],
              'subject'             => $data['post_data']['subject'],
              'system'              => $data['post_data']['system'],
              'type'                => $data['post_data']['type'],
              'type_description'    => $data['type'][0]['name'],
              'status'              => $data['post_data']['status'],
              'status_description'  => $stat_dsc,
              'receive'             => 0,
              'sender_id'           => $data['user_token'],
              'sender_name'         => $data['snder'],
              'receiver_division'   => (!empty($data['multiprsnl'][$key][1])) ? $data['multiprsnl'][$key][1] : $data['cred_snder'][0]['divno'],
              'receiver_section'    => $data['multiprsnl'][$key][2],
              'receiver_region'     => (!empty($data['multiprsnl'][$key][0])) ? $data['multiprsnl'][$key][0] : $data['cred_snder'][0]['region'],
              'receiver_id'         => (!empty($data['multiprsnl'][$key][3])) ? $data['multiprsnl'][$key][3] : 0,
              'receiver_name'       => (!empty($data['multiprsnl'][$key][4])) ? $data['multiprsnl'][$key][4] : '--',
              'action_taken'        => $data['post_data']['action'],
              'remarks'             => (!empty($data['multiprsnl'][$key][5])) ? $data['multiprsnl'][$key][5] : $data['post_data']['remarks'],
              // 'remarks'             => $data['post_data']['remarks'],
              'start_date'          => $data['trnsctn'][0]['start_date'],
              'records_location'    => !empty($data['post_data']['records_location']) ? $data['post_data']['records_location'] : '',
              'region'              => $data['trnsctn'][0]['region'],
            );
            $result = $this->Embismodel->insertdata( 'er_transactions_multi', $insert['er_trans_multi'] );

            // Update transaction sets multiprc to 1
            if($result)
            {
              $translog_vars = array(
                'set'   => array(
                  'et.route_order'        => $data['trnsctn'][0]['route_order']+1,
                  'et.multiprc'           => 1,
                  'et.company_token'      => $data['post_data']['company'],
                  'et.company_name'       => $data['company'][0]['company_name'],
                  'et.emb_id'             => $data['company'][0]['emb_id'],
                  'et.subject'            => $data['post_data']['subject'],
                  'et.system'             => $data['post_data']['system'],
                  'et.type'               => $data['post_data']['type'],
                  'et.type_description'   => $data['type'][0]['name'],
                  'et.status'             => $data['post_data']['status'],
                  'et.status_description' => $stat_dsc,
                  'et.receive'            => 0,
                  'et.receiver_division'  => '',
                  'et.receiver_section'   => '',
                  'et.receiver_region'    => '',
                  'et.receiver_id'        => 0,
                  'et.receiver_name'      => '--',
                  'et.action_taken'       => $data['post_data']['action'],
                  'et.remarks'            => $data['post_data']['remarks'],
                  'et.records_location'   => !empty($data['post_data']['records_location']) ? $data['post_data']['records_location'] : '',
                  'et.qr_code_token'      => (!empty($data['trnsctn'][0]['qr_code_token']) ? $data['trnsctn'][0]['qr_code_token'] : (!empty($data['post_data']['qr_code']) ? $data['post_data']['qr_code'] : '')),
                  'et.tag_doc_type'       => !empty($data['post_data']['tag_doc_type']) ? $data['post_data']['tag_doc_type'] : 0,
                ),
                'where' => array(
                  'et.trans_no'         => $data['trnsctn'][0]['trans_no'],
                  'et.route_order'      => $data['trnsctn'][0]['route_order'],
                ),
              );
              $result = $this->Embismodel->updatedata( $translog_vars['set'], 'er_transactions AS et', $translog_vars['where'] );
            }
          }
        }
        else // equal to 0 (normal flow)
        {
          $res['translog'] = '';

          // GETTING FUNCTION OF RECEIVER (DIVISION, SECTION)
          $rcvr_func['data'] = array(
            'id'    => 0,
            'divno' => '',
            'secno' => '',
          );
          if(!empty($data['post_data']['receiver']))
          {
            $rcvr_func['where'] = array('afn.userid' => $data['cred_rcver'][0]['userid'], 'afn.stat' => 1 );
            $rcvr_func['result'] = $this->Embismodel->selectdata( 'acc_function AS afn', '',  $rcvr_func['where'] );
            if(!empty($rcvr_func['result']))
            {
              $rcvr_func['data'] = array(
                'id'    => $data['post_data']['receiver'],
                'divno' => $rcvr_func['result'][0]['divno'],
                'secno' => $rcvr_func['result'][0]['secno'],
              );
            }
          }

          // Update Transaction Log inserted upon Receiving the Transaction ( on function receive_transaction )
          $translog_data = array(
            'set'   => array(
              'etl.subject'             => $data['post_data']['subject'],
              'etl.sender_divno'        => $data['user_divno'],
              'etl.sender_secno'        => $data['user_secno'],
              'etl.sender_id'           => $data['user_token'],
              'etl.sender_ipadress'     => $this->input->ip_address(),
              'etl.receiver_divno'      => $rcvr_func['data']['divno'],
              'etl.receiver_secno'      => $rcvr_func['data']['secno'],
              'etl.receiver_id'         => $rcvr_func['data']['id'],
              'etl.receiver_name'       => (!empty($data['rcver'])) ? $data['rcver'] : '--',
              'etl.receiver_region'     => $data['cred_rcver'][0]['region'],
              'etl.type'                => $data['post_data']['type'],
              'etl.status'              => $data['post_data']['status'],
              'etl.status_description'  => $stat_dsc,
              'etl.action_taken'        => $data['post_data']['action'],
              'etl.remarks'             => $data['post_data']['remarks'],
              'etl.date_out'            => $data['date_out'],
            ),
            'where' => array(
              'etl.trans_no'            => $data['post_data']['trans_no'],
              'etl.route_order'         => $data['trnsctn'][0]['route_order']+1,
              'etl.sender_id'           => $data['user_token'],
            ),
          );
          $res['translog'] = $this->Embismodel->updatedata( $translog_data['set'], 'er_transactions_log AS etl', $translog_data['where'] );

          // Update Transaction (full) Data
          if($res['translog'])
          {
            $trans_vars = array(
              'set'   => array(
                'et.route_order'        => $data['trnsctn'][0]['route_order']+1,
                'et.company_token'      => $data['post_data']['company'],
                'et.company_name'       => $data['company'][0]['company_name'],
                'et.emb_id'             => $data['company'][0]['emb_id'],
                'et.subject'            => $data['post_data']['subject'],
                'et.system'             => $data['post_data']['system'],
                'et.type'               => $data['post_data']['type'],
                'et.type_description'   => $data['type'][0]['name'],
                'et.status'             => $data['post_data']['status'],
                'et.status_description' => $stat_dsc,
                'et.receive'            => 0,
                'et.sender_id'          => $data['user_token'],
                'et.sender_name'        => $data['snder'],
                'et.receiver_division'  => (!empty($data['post_data']['division'])) ? $data['post_data']['division'] : $data['cred_snder'][0]['divno'],
                'et.receiver_section'   => $data['post_data']['section'],
                'et.receiver_region'    => (!empty($data['cred_rcver'][0]['region'])) ? $data['cred_rcver'][0]['region'] : $data['cred_snder'][0]['region'],
                'et.receiver_id'        => (!empty($data['post_data']['receiver'])) ? $data['post_data']['receiver'] : 0,
                'et.receiver_name'      => (!empty($data['rcver'])) ? $data['rcver'] : '--',
                'et.action_taken'       => $data['post_data']['action'],
                'et.remarks'            => $data['post_data']['remarks'],
                'et.records_location'   => !empty($data['post_data']['records_location']) ? $data['post_data']['records_location'] : '',
                'et.qr_code_token'      => (!empty($data['trnsctn'][0]['qr_code_token']) ? $data['trnsctn'][0]['qr_code_token'] : (!empty($data['post_data']['qr_code']) ? $data['post_data']['qr_code'] : '')),
                'et.tag_doc_type'       => !empty($data['post_data']['tag_doc_type']) ? $data['post_data']['tag_doc_type'] : 0,
              ),
              'where' => array(
                'et.trans_no' => $data['post_data']['trans_no'],
              ),
            );
            $result = $this->Embismodel->updatedata( $trans_vars['set'], 'er_transactions AS et', $trans_vars['where'] );
          }
        }
      }

      if($result) {
        // SUBCATEGORIES OF SUBTYPES
        $this->add_inputs_tbdb($data);
        // UNIVERSE DATA
        $this->universe_insert($data);
      }

      if($result)
      {
        $swal_arr = array(
          'title'     => '<span style="font-weight:bolder">SUCCESS!</span>',
          // 'text'      => 'IIS No. '.$data['trnsctn'][0]['token'].' processing successful.',
          'text'      => '[IIS Reference No.] '.$data['trnsctn'][0]['token'].'<br />Your Transaction has been Successfully Forwarded.<br />Thank you!',
          'type'      => 'success',
        );
        $this->session->set_flashdata('swal_arr', $swal_arr);

        if(!empty($this->session->userdata('current_dms_tab')))
        {
          switch ($this->session->userdata('current_dms_tab')) {
            case 'inbox':
              $red_url = !empty($this->dmsdata['user_options']['inbox_prc']) ? $this->dmsdata['user_options']['inbox_prc'] : 'outbox';
              break;

            case 'draft':
              $red_url = !empty($this->dmsdata['user_options']['draft_prc']) ? $this->dmsdata['user_options']['draft_prc'] : 'outbox';
              break;

            default:
              $red_url = 'outbox';
              break;
          }
        }
        else {
          $red_url = 'outbox';
        }
        $red_url = !empty($this->dmsdata['user_options']['inbox_prc']) ? $this->dmsdata['user_options']['inbox_prc'] : 'outbox';
        redirect( base_url('Dms/Dms/'.$red_url));
      }
      else {
        $swal_arr = array(
          'title'     => 'ERROR!',
          'text'      => 'Error upon processing IIS No. '.$data['trnsctn'][0]['token'].'. Please contact Administrator. Error Code: [DMS-PRC-Rslt]',
          'type'      => 'error',
        );
        $this->session->set_flashdata('swal_arr', $swal_arr);

        $red_url = !empty($this->dmsdata['user_options']['inbox_prc']) ? $this->dmsdata['user_options']['inbox_prc'] : 'outbox';
        redirect( base_url('Dms/Dms/'.$red_url));
      }
    }

    function add_inputs_tbdb($data='')
    {
      if(!empty($data['post_data']['system']) && !empty($data['post_data']['type']))
      {
        if(!empty($data['post_data']['appli_type']))
        {
          $where['sub_type'] = array(
            'est.id'      => $data['post_data']['appli_type'],
            'est.ssysid'  => $data['post_data']['type']
          );
          $sub_type = $this->Embismodel->selectdata('er_sub_type AS est', '', $where['sub_type'] );
          $subtype_dsc = $sub_type[0]['dsc'];
        }
        else {
          $subtype_dsc = '';
        }

        switch ($data['post_data']['system']) {
          case 1: // ORD
            $esa_where = array( 'esa.trans_no' => $data['trans_session'] );
            $esa = $this->Embismodel->selectdata('er_system_ord AS esa', '', $esa_where );

            $esa_vars = array(
              'table_up'  => 'er_system_ord AS esa',
              'table_ins' => 'er_system_ord',
              'insert'    => array(
                'trans_no'            => $data['trans_session'],
                'sub_system'          => $data['post_data']['type'],
                'sub_desc'            => $data['type'][0]['name'],
                'subtype_id'          => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'subtype_desc'        => $subtype_dsc,
              ),
              'set'       => array(
                'esa.sub_system'      => $data['post_data']['type'],
                'esa.sub_desc'        => $data['type'][0]['name'],
                'esa.subtype_id'      => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'esa.subtype_desc'    => $subtype_dsc,
              ),
              'where'     => array(
                'esa.trans_no'        => $data['trans_session'],
              )
            );
            break;

          case 2: // ADMINISTRATIVE
            $esa_where = array( 'esa.trans_no' => $data['trans_session'] );
            $esa = $this->Embismodel->selectdata('er_system_admin AS esa', '', $esa_where );

            $esa_vars = array(
              'table_up'  => 'er_system_admin AS esa',
              'table_ins' => 'er_system_admin',
              'insert'    => array(
                'trans_no'            => $data['trans_session'],
                'sub_system'          => $data['post_data']['type'],
                'sub_desc'            => $data['type'][0]['name'],
                'subtype_id'          => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'subtype_desc'        => $subtype_dsc,
              ),
              'set'       => array(
                'esa.sub_system'      => $data['post_data']['type'],
                'esa.sub_desc'        => $data['type'][0]['name'],
                'esa.subtype_id'      => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'esa.subtype_desc'    => $subtype_dsc,
                ),
              'where'     => array(
                'esa.trans_no'        => $data['trans_session'],
              )
            );
            break;

          case 4: // PERMITTING
            $esa_where = array( 'esa.trans_no' => $data['trans_session'] );
            $esa = $this->Embismodel->selectdata('er_system_permit AS esa', '', $esa_where );

            $esa_vars = array(
              'table_up'    => 'er_system_permit AS esa',
              'table_ins'   => 'er_system_permit',
              'insert'      => array(
                'trans_no'              => $data['trans_session'],
                'sub_system'            => $data['post_data']['type'],
                'sub_desc'              => $data['type'][0]['name'],
                'subtype_id'            => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'subtype_desc'          => $subtype_dsc,
                'permit_no'             => (!empty($data['post_data']['permit_no'])) ? $data['post_data']['permit_no'] : '',
                'consultant_id'         => '',
                'consultant_name'       => '',
                'exp_start_date'        => (!empty($data['post_data']['exp_start_date'])) ? $data['post_data']['exp_start_date'] : '0000-00-00',
                'exp_end_date'          => (!empty($data['post_data']['exp_end_date'])) ? $data['post_data']['exp_end_date'] : '0000-00-00',
              ),
              'set'         => array(
                'esa.sub_system'        => $data['post_data']['type'],
                'esa.sub_desc'          => $data['type'][0]['name'],
                'esa.subtype_id'        => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'esa.subtype_desc'      => $subtype_dsc,
                'esa.permit_no'         => (!empty($data['post_data']['permit_no'])) ? $data['post_data']['permit_no'] : '',
                'esa.consultant_id'     => '',
                'esa.consultant_name'   => '',
                'esa.exp_start_date'    => (!empty($data['post_data']['exp_start_date'])) ? $data['post_data']['exp_start_date'] : '0000-00-00',
                'esa.exp_end_date'      => (!empty($data['post_data']['exp_end_date'])) ? $data['post_data']['exp_end_date'] : '0000-00-00',
                ),
              'where'       => array(
                'esa.trans_no'          => $data['trans_session'],
              )
            );
            break;

          case 10: // LAB
            $esa_where = array( 'esa.trans_no' => $data['trans_session'] );
            $esa = $this->Embismodel->selectdata('er_system_lab AS esa', '', $esa_where );

            $esa_vars = array(
              'table_up'  => 'er_system_lab AS esa',
              'table_ins' => 'er_system_lab',
              'insert'    => array(
                'trans_no'            => $data['trans_session'],
                'sub_system'          => $data['post_data']['type'],
                'sub_desc'            => $data['type'][0]['name'],
                'subtype_id'          => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'subtype_desc'        => $subtype_dsc,
              ),
              'set'       => array(
                'esa.sub_system'      => $data['post_data']['type'],
                'esa.sub_desc'        => $data['type'][0]['name'],
                'esa.subtype_id'      => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'esa.subtype_desc'    => $subtype_dsc,
              ),
              'where'     => array(
                'esa.trans_no'        => $data['trans_session'],
              )
            );
            break;

          case 11: // EEIU
            $esa_where = array( 'esa.trans_no' => $data['trans_session'] );
            $esa = $this->Embismodel->selectdata('er_system_eeiu AS esa', '', $esa_where );

            $esa_vars = array(
              'table_up'  => 'er_system_eeiu AS esa',
              'table_ins' => 'er_system_eeiu',
              'insert'    => array(
                'trans_no'            => $data['trans_session'],
                'sub_system'          => $data['post_data']['type'],
                'sub_desc'            => $data['type'][0]['name'],
                'subtype_id'          => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'subtype_desc'        => $subtype_dsc,
              ),
              'set'       => array(
                'esa.sub_system'      => $data['post_data']['type'],
                'esa.sub_desc'        => $data['type'][0]['name'],
                'esa.subtype_id'      => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'esa.subtype_desc'    => $subtype_dsc,
              ),
              'where'     => array(
                'esa.trans_no'        => $data['trans_session'],
              )
            );
            break;

          case 12: // RECORDS
            $esa_where = array( 'esa.trans_no' => $data['trans_session'] );
            $esa = $this->Embismodel->selectdata('er_system_rec AS esa', '', $esa_where );

            $esa_vars = array(
              'table_up'  => 'er_system_rec AS esa',
              'table_ins' => 'er_system_rec',
              'insert'    => array(
                'trans_no'            => $data['trans_session'],
                'sub_system'          => $data['post_data']['type'],
                'sub_desc'            => $data['type'][0]['name'],
                'subtype_id'          => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'subtype_desc'        => $subtype_dsc,
                'type_no'             => (!empty($data['post_data']['type_no'])) ? trim($data['post_data']['type_no']) : '',
              ),
              'set'       => array(
                'esa.sub_system'      => $data['post_data']['type'],
                'esa.sub_desc'        => $data['type'][0]['name'],
                'esa.subtype_id'      => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'esa.subtype_desc'    => $subtype_dsc,
                'esa.type_no'         => (!empty($data['post_data']['type_no'])) ? trim($data['post_data']['type_no']) : '',
              ),
              'where'     => array(
                'esa.trans_no'        => $data['trans_session'],
              )
            );
            break;

          case 13: // LEGAL
            $esa_where = array( 'esa.trans_no' => $data['trans_session'] );
            $esa = $this->Embismodel->selectdata('er_system_legal AS esa', '', $esa_where );

            $esa_vars = array(
              'table_up'  => 'er_system_legal AS esa',
              'table_ins' => 'er_system_legal',
              'insert'    => array(
                'trans_no'            => $data['trans_session'],
                'sub_system'          => $data['post_data']['type'],
                'sub_desc'            => $data['type'][0]['name'],
                'subtype_id'          => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'subtype_desc'        => $subtype_dsc,
              ),
              'set'       => array(
                'esa.sub_system'      => $data['post_data']['type'],
                'esa.sub_desc'        => $data['type'][0]['name'],
                'esa.subtype_id'      => (!empty($data['post_data']['appli_type'])) ? $data['post_data']['appli_type'] : 0,
                'esa.subtype_desc'    => $subtype_dsc,
              ),
              'where'     => array(
                'esa.trans_no'        => $data['trans_session'],
              )
            );
            break;

          default:
            $esa = '';
            break;
        }

        if(!empty($esa)) {
          $result = $this->Embismodel->updatedata( $esa_vars['set'] , $esa_vars['table_up'], $esa_vars['where'] );
        }
        else {
          $result = $this->Embismodel->insertdata( $esa_vars['table_ins'], $esa_vars['insert'] );
        }
      }
    }

    function universe_insert($data='')
    {
      switch ($data['post_data']['type']) {
        case 1: $type = 'ecc'; break;
        case 2: $type = 'cnc'; break;
        case 3: $type = 'luc'; break;
        case 4: $type = 'dp'; break;
        case 5: $type = 'po'; break;
        case 27: $type = 'pco'; break;
        case 8: $type = 'sqi'; break;
        case 7: $type = 'piccs'; break;
        case 10: $type = 'ccoic'; break;
        case 9: $type = 'ccoreg'; break;
        case 34: $type = 'cot'; break;
        case 33: $type = 'mnfst'; break;
        case 32: $type = 'ptt'; break;
        case 47: $type = 'tsd'; break;
        case 6: $type = 'hwgen'; break;
        case 48: $type = 'trc'; break;
        default: $type = ''; break;
      }

      if(!empty($type))
      {
        $set_in = 'du.'.$type;
        $univ_vars = array(
          'table' => 'dms_universe AS du',
          'set'   => array( $set_in   => $data['post_data']['status'] ),
          'where' => array('du.token' => $data['post_data']['company']),
        );
        $result = $this->Embismodel->updatedata($univ_vars['set'], $univ_vars['table'], $univ_vars['where']);
      }
    }

    function delete_transaction()
    {
      if(isset($_POST['delete_trans_btn']))
      {
        $data['post_data'] = $this->input->post('multidlte_trans_no');

        foreach ($data['post_data'] as $key => $value) {
          $trans_vars = array(
            'table' => 'er_transactions AS et',
            'set'   => array( 'et.status'   => 0, ),
            'where' => array( 'et.trans_no' => $value ),
          );
          $result = $this->Embismodel->updatedata( $trans_vars['set'], $trans_vars['table'], $trans_vars['where'] );
        }

        if(count($data['post_data']) > 1) {
          $trans_no = 'Numbers : ';
          foreach ($data['post_data'] as $key => $value) {
            $trans_no .= $value.', ';
          }
        }
        else {
          $trans_no = 'No. '.$data['post_data'][0];
        }
        if($result)
        {
          $swal_arr = array(
            'title'     => '- Deleted -',
            'text'      => 'IIS '.$trans_no.' deleted successfully.',
            'type'      => 'success',
          );
          $this->session->set_flashdata('swal_arr', $swal_arr);
        }
      }
      else {
        $swal_arr = array(
          'title'     => '- ErRoR -',
          'text'      => 'There was an error upon deletion on DMS - Revisions. Please contact System Administrator.',
          'type'      => 'error',
        );
        $this->session->set_flashdata('swal_arr', $swal_arr);
      }
      redirect(base_url('Dms/Dms/revisions'));
    }

    function confidential_transaction()
    {
      if(isset($_POST['confidential_trans_btn']))
      {
        $data['post_data'] = $this->input->post('multiconfidential_trans_no');

        foreach ($data['post_data'] as $key => $value) {

          $confi_trans = array(
            'table'   => 'er_transactions AS et',
            'select'  => 'et.tag_doc_type',
            'where'   => array( 'et.trans_no' => $value ),
          );
          $confi_result = $this->Embismodel->selectdata( $confi_trans['table'], $confi_trans['select'], $confi_trans['where'] );

          $confi_set = ($confi_result[0]['tag_doc_type'] == 0) ? 1 : 0;

          $trans_vars = array(
            'table' => 'er_transactions AS et',
            'set'   => array( 'et.tag_doc_type' => $confi_set ),
            'where' => array( 'et.trans_no' => $value ),
          );
          $result = $this->Embismodel->updatedata( $trans_vars['set'], $trans_vars['table'], $trans_vars['where'] );
        }

        if(count($data['post_data']) > 1) {
          $trans_no = 'Numbers : ';
          foreach ($data['post_data'] as $key => $value) {
            $trans_no .= $value.', ';
          }
        }
        else {
          $trans_no = 'No. '.$data['post_data'][0];
        }
        if($result)
        {
          $swal_arr = array(
            'title'     => '- SET/UNSET -',
            'text'      => 'IIS '.$trans_no.' set/unset successfully.',
            'type'      => 'success',
          );
          $this->session->set_flashdata('swal_arr', $swal_arr);
        }
      }
      else {
        $swal_arr = array(
          'title'     => '- ErRoR -',
          'text'      => 'There was an error upon deletion on DMS - Revisions. Please contact System Administrator.',
          'type'      => 'error',
        );
        $this->session->set_flashdata('swal_arr', $swal_arr);
      }
      redirect(base_url('Dms/Dms/revisions'));
    }

    function update_transrec()
    {
      if(isset($_POST['relocate_transrec']))
      {
        $data['post_data'] = $this->input->post();
        $trans_vars = array(
          'table' => 'er_transactions AS et',
          'set'   => array( 'et.records_location' => $data['post_data']['transrec_location'] ),
          'where' => array( 'et.trans_no'         => $data['post_data']['transrec_no'] ),
        );
        $result = $this->Embismodel->updatedata( $trans_vars['set'], $trans_vars['table'], $trans_vars['where'] );
        if($result)
        {
          $swal_arr = array(
            'title'     => '- Updated -',
            'text'      => 'Record of IIS No. '.$data['post_data']['transrec_no'].' updated successfully.',
            'type'      => 'success',
          );
          $this->session->set_flashdata('swal_arr', $swal_arr);
        }
      }
      else {
        $swal_arr = array(
          'title'     => '- ErRoR -',
          'text'      => 'There was an error upon updating data in DMS - Records. Please contact System Administrator.',
          'type'      => 'error',
        );
        $this->session->set_flashdata('swal_arr', $swal_arr);
      }

        redirect(base_url('Dms/Dms/records'));
    }

    function filter_query()
    {
      $where['fltr_comp'] = ($this->dmsdata['user_region'] == 'CO') ? '' : array( 'dc.region_name' => $this->dmsdata['user_region'] );
      $this->dmsdata['fltr_comp'] = $this->Embismodel->selectdata('dms_company AS dc', 'emb_id, company_id, company_name, establishment_name, token', $where['fltr_comp'], $this->db->order_by('dc.company_name', 'asc'));
      $this->dmsdata['fltr_systm'] = $this->Embismodel->selectdata('er_systems AS esy', '', '', $this->db->order_by('esy.system_order', 'asc'));
      $this->dmsdata['fltr_stat'] = $this->Embismodel->selectdata('er_status AS est', '', '');

      $where['prsnl_cred'] = array('ac.region' => $this->dmsdata['user_region'], 'ac.verified' => 1);
      $this->dmsdata['fltr_prsnl'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $where['prsnl_cred'] );

      $this->dmsdata['modal'] = 'dms_filter';

      $this->load->view('Dms/func/onclick_modals', $this->dmsdata);
    }

    function multipersonnels()
    {
      $rcvr = $this->input->post('receiver');
      $cnt = 0;
      $data[] = '';
      foreach ($rcvr as $key => $value) {
        if(!empty($value)) {
          foreach ($this->input->post() as $postkey => $postvalue) {
            $data[$cnt][$postkey] = $postvalue[$key];
          }
          $where['multiprsnl'] = array('ac.token' => $value);
          $multiprsnl = $this->Embismodel->selectdata('acc_credentials AS ac', '', $where['multiprsnl'] );

          $division = (!empty($multiprsnl[0]['division'])) ? '|'.$multiprsnl[0]['division'] : '';

          $section = '';
          if(!empty($multiprsnl[0]['secno']))
          {
            $sec_where = array( 'axs.secno'  => $multiprsnl[0]['secno'] );
            $section = $this->Embismodel->selectdata('acc_xsect AS axs', '', $sec_where);
            $section = '|'.$section[0]['secode'];
          }

          $data[$cnt]['name'] = trim(ucwords($multiprsnl[0]['fname'].' '.substr($multiprsnl[0]['mname'], 0, 1).' '.$multiprsnl[0]['sname'].' '.$multiprsnl[0]['suffix']));
          $data[$cnt]['prsnl'] = trim(ucwords($multiprsnl[0]['fname'].' '.$multiprsnl[0]['sname'].' '.$multiprsnl[0]['suffix']).' - '.$multiprsnl[0]['region'].$division.$section);
          $cnt++;
        }
      }
      echo json_encode($data);
    }

    // ====================================================        COMMON METHODS           =========================================================== //


    function assigned_slctn()
    {
      $reg_type = (!empty($this->dmsdata['trans_data'][0]['receiver_region'])) ? $this->dmsdata['trans_data'][0]['receiver_region'] : $this->dmsdata['user_region'];

      $reg_type = ($reg_type == 'CO') ? 'co' : 'region';
      // $div_where = array('adv.type' => $reg_type, 'adv.office' =>'EMB' );
      $div_where = $this->db->where('adv.office = "'.$this->session->userdata('office').'" AND (adv.type = "'.$reg_type.'" OR adv.type = "'.$this->session->userdata('region').'")');
      // if($this->dmsdata['function'][0]['func'] == 'Administrator') {
      //   $div_where = array('adv.type' => $reg_type );
      // }
      // else {
      //   $div_where = array(
      //     'adv.type'  => $reg_type,
      //     'adv.divno' => $this->dmsdata['function'][0]['divno'],
      //   );
      // }


      // switch ($this->dmsdata['function'][0]['func']) {
      //   case 'Administrator':
      //   case 'Sample User':
      //     $div_where = array('adv.type' => $reg_type );
      //     break;

      //   case 'Director':
      //   case 'Assistant Director':
      //     $div_where = array('adv.type' => $reg_type );
      //     break;

      //   case 'Division Chief':
      //   case 'Assistant Division Chief':
      //     $div_where = array('adv.type' => $reg_type );
      //     break;

      //   case 'Section Chief':
      //     $div_where = array(
      //       'adv.type'  => $reg_type,
      //       'adv.divno' => $this->dmsdata['function'][0]['divno'],
      //     );
      //     break;

      //   default:
      //     if(!empty($this->dmsdata['credentials'][0]['secno']))
      //     {
      //       if($this->dmsdata['user_region'] == 'CO')
      //       {
      //         switch ($this->dmsdata['credentials'][0]['divno']) {
      //           case 14: // OFFICE OF THE DIRECTOR
      //             $div_where = array('adv.type' => $reg_type );
      //             break;

      //           default:
      //             $div_where = array(
      //               'adv.type'  => $reg_type,
      //               'adv.divno' => $this->dmsdata['function'][0]['divno'],
      //             );
      //             break;
      //         }
      //       }
      //       else {
      //         switch ($this->dmsdata['credentials'][0]['divno']) {
      //           case 1: // OFFICE OF THE REGIONAL DIRECTOR
      //             $div_where = array('adv.type' => $reg_type );
      //             break;

      //           default:
      //             $div_where = array(
      //               'adv.type'  => $reg_type,
      //               'adv.divno' => $this->dmsdata['function'][0]['divno'],
      //             );
      //             break;
      //         }
      //       }
      //     }
      //     else {
      //       $div_where = array(
      //         'adv.type'  => $reg_type,
      //         'adv.divno' => $this->dmsdata['function'][0]['divno'],
      //       );
      //     }
      //     break;
      // }

      $this->dmsdata['division'] = $this->Embismodel->selectdata('acc_xdvsion AS adv', '', '', $div_where);
      // print_r($this->dmsdata['division']); exit;
      // }
    }

    function add_inputs()
    {
      if(!empty($this->dmsdata['trans_data'][0]['type']))
      {
        $est_vars = '';
        switch ($this->dmsdata['trans_data'][0]['system']) {
          case 1: $est_vars = array( 'table' => 'er_system_ord AS est' ); break; // ORD
          case 2: $est_vars = array( 'table' => 'er_system_admin AS est' ); break; // ADMINISTRATIVE
          case 3: $est_vars = array( 'table' => 'er_system_finance AS est' ); break; // FINANCIAL
          case 4: $est_vars = array( 'table' => 'er_system_permit AS est' ); break; // PERMITTING
          case 12: $est_vars = array( 'table' => 'er_system_rec AS est' ); break; // RECORDS
          case 13: $est_vars = array( 'table' => 'er_system_legal AS est' ); break; // RECORDS
          default: $est_vars = array( 'table' => '' ); break; // DEFAULT
        }

        if(!empty($est_vars['table']))
        {
          $est_vars += array(
            'where' => array( 'est.trans_no' => $this->dmsdata['trans_session'] )
          );
          $this->dmsdata['system_types'] = $this->Embismodel->selectdata($est_vars['table'], '', $est_vars['where']);

          $est_vars['where'] = array( 'est.ssysid'  => $this->dmsdata['system_types'][0]['sub_system'] );
          $this->dmsdata['sub_types'] = $this->Embismodel->selectdata('er_sub_type AS est', '', $est_vars['where']);
        }

        $this->dmsdata['add_input'] = $this->load->view('Dms/func/updateinputs', $this->dmsdata, TRUE);
      }
    }

    function attachment_exists()
    {
      // $route_order = $this->dmsdata['trans_data'][0]['route_order']+1;

      if(!empty($this->dmsdata['trans_data'][0]['route_order']))
      {
        $ea_where = array(
          'ea.trans_no'         => $this->dmsdata['trans_session'],
          'ea.route_order'      => $this->dmsdata['trans_data'][0]['route_order']+1,
          'ea.main_multi_cntr'  => $this->session->userdata('main_multi_cntr'),
          'ea.multi_cntr'       => $this->session->userdata('multi_cntr'),
        );
      }
      else {
        $ea_where = array(
          'ea.trans_no'         => $this->dmsdata['trans_session'],
          'ea.route_order'      => $this->dmsdata['trans_data'][0]['route_order']+1,
          'ea.main_multi_cntr'  => $this->session->userdata('main_multi_cntr'),
          'ea.deleted'          => 0,
        );
      }
      $ea_slct = $this->Embismodel->selectdata( 'er_attachments AS ea', '', $ea_where );

      // if($route_order == 1) {
        if(!$ea_slct) {
          return false;
        }
        else {
          return true;
        }
      // }
      // else {
      //   return true;
      // }
    }

    function ajax_attachment_exists()
    {
      echo 'true';
    }

    // ============================================        AJAX FUNCTIONS           ===================================================== //

    function additional_inputs()
    {
      $data = $this->input->post();

      $type_where = array( 'et.id' => $data['subsystem'] );
      $data['type'] = $this->Embismodel->selectdata('er_type AS et', '', $type_where);

      if($data['system'] == 6)
      {
        $subtype_vars = array(
          'table' => 'er_sub_swm AS ess',
          'where' => array( 'ess.ssysid'  => $data['subsystem'] ),
          'order' => 'ess.ssysid asc',
        );
      }
      else {
        $subtype_vars = array(
          'table' => 'er_sub_type AS est',
          'where' => array(
            'est.sysid'   => $data['system'],
            'est.ssysid'  => $data['subsystem']
          ),
          'order' => 'est.sysid asc, est.ssysid asc',
        );
      }

      $data['sub_types'] = $this->Embismodel->selectdata( $subtype_vars['table'], '', $subtype_vars['where'], $subtype_vars['order'] );

      $this->load->view('Dms/func/addinputs', $data);
    }

    function view_transaction()
    {
      $this->dmsdata['post_data'] = $this->input->post();

      // query of transaction's data (single)
      // !empty($this->dmsdata['post_data']['multiprc']) &&
      if($this->dmsdata['post_data']['multiprc'] > 0) {
        $trans_where = array(
          'etm.trans_no'     => $this->dmsdata['post_data']['trans_no'],
          'etm.receiver_id'  => $this->dmsdata['user_token'],
        );
        $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions_multi AS etm', '', $trans_where);
      }
      else {
        $trans_where = array( 'et.trans_no' => $this->dmsdata['post_data']['trans_no'] );
        $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions AS et', '', $trans_where);
      }

      // query of system
      $type_where = array('es.id' => $this->dmsdata['trans_data'][0]['system'] );
      $this->dmsdata['system'] = $this->Embismodel->selectdata('er_systems AS es', '', $type_where);

      // query of company details
      $dcomp_where = array( 'dcd.token' => $this->dmsdata['trans_data'][0]['company_token'] );
      $this->dmsdata['company_details'] = $this->Embismodel->selectdata('dms_company AS dcd', '', $dcomp_where);

      $this->dmsdata['prepAddr'] = str_replace(' ', '+', $this->dmsdata['company_details'][0]['company_name']);
      $this->dmsdata['prepAddr'] .= '+'.str_replace(' ', '+', $this->dmsdata['company_details'][0]['city_name'].'+'.$this->dmsdata['company_details'][0]['province_name']);

      $this->dmsdata['geocode'] = file_get_contents('https://maps.google.com/maps/api/geocode/json?address='.$this->dmsdata['prepAddr'].'&sensor=false&key=AIzaSyAnuAfDgC46Vy3Aq-ej6_zXrw6YbvHDgDA&token=35779');

      $this->dmsdata['geocode'] = json_decode($this->dmsdata['geocode']);

      // query of transaction's data (multiple)
      $trans_where = array( 'etrns.trans_no' => $this->dmsdata['post_data']['trans_no'] );
      $this->dmsdata['trans_multi'] = $this->Embismodel->selectdata('er_transactions_multi AS etrns', '', $trans_where);

      // checks personnel if he/she is in the this transaction's log
      $where['inthread'] = $this->db->where('etl.trans_no = "'.$this->dmsdata['post_data']['trans_no'].'" AND ( etl.sender_id = "'.$this->dmsdata['user_token'].'" OR etl.receiver_id =  "'.$this->dmsdata['user_token'].'" )');
      $this->dmsdata['prnl_inthread'] = $this->Embismodel->selectdata('er_transactions_log AS etl', '', '', $where['inthread'] );

      $this->dmsdata['special_view'] = FALSE;
      //special viewing (mon.rep, eia, haz, chem)
      if( $this->dmsdata['trans_data'][0]['type'] == 23 && $this->dmsdata['user_rights']['view_monitoring_report'] == 'yes')
      {
       $this->dmsdata['special_view'] = TRUE;
      }
      if( in_array($this->dmsdata['trans_data'][0]['type'], array(1, 2,3,74)) && $this->dmsdata['user_rights']['view_eia'] == 'yes')
      {
       $this->dmsdata['special_view'] = TRUE;
      }
      if( in_array($this->dmsdata['trans_data'][0]['type'], array(7,8,9,10,76)) && $this->dmsdata['user_rights']['view_chem'] == 'yes')
      {
       $this->dmsdata['special_view'] = TRUE;
      }
      if( in_array($this->dmsdata['trans_data'][0]['type'], array(6,32,33,34,47,48,77,98,105,112,113)) && $this->dmsdata['user_rights']['view_haz'] == 'yes')
      {
       $this->dmsdata['special_view'] = TRUE;
      }
      // if( in_array($this->dmsdata['trans_data'][0]['type'], array(4,5,27,75)) && $this->dmsdata['user_rights']['view_airwater'] == 'yes')
      // {
      //  $this->dmsdata['special_view'] = TRUE;
      // }

      // query of transaction's log
      $history_where = array(
        'etl.trans_no'          => $this->dmsdata['post_data']['trans_no'],
        'etl.main_multi_cntr'   => '',
       );
      $history_order = $this->db->order_by('etl.main_route_order ASC, etl.route_order ASC, etl.multi_cntr ASC');
      $this->dmsdata['trans_history'] = $this->Embismodel->selectdata('er_transactions_log AS etl', '', $history_where, $history_order );
      // query of attachments
      foreach ($this->dmsdata['trans_history'] as $key => $value) {
        $ea_where = array(
          'eat.trans_no'    => $value['trans_no'],
          'eat.route_order' => $value['route_order'],
          'eat.deleted'      => 0,
        );
        $ea_order = $this->db->order_by('eat.route_order', 'desc');
        $this->dmsdata['attachment_view'][$key] = $this->Embismodel->selectdata('er_attachments AS eat', '', $ea_where, $ea_order );

        $from_name['axd_where'] = array( 'axd.divno' => $value['sender_divno'] );
        $from_name['div'] = $this->Embismodel->selectdata('acc_xdvsion AS axd', '', $from_name['axd_where'] );
        $from_div = (!empty($from_name['div'])) ?  $from_name['div'][0]['divcode'] : '';

        $from_name['axs_where'] = array( 'axs.secno' => $value['sender_secno'] );
        $from_name['sec'] = $this->Embismodel->selectdata('acc_xsect AS axs', '', $from_name['axs_where'] );
        $from_sec = (!empty($from_name['sec'])) ? '|'.$from_name['sec'][0]['secode'] : '';

        $this->dmsdata['from_name'][$key] = $from_div.$from_sec.' - ';

        $receiver_name['axd_where'] = array( 'axd.divno' => $value['receiver_divno'] );
        $receiver_name['div'] = $this->Embismodel->selectdata('acc_xdvsion AS axd', '', $receiver_name['axd_where'] );
        $receiver_div = (!empty($receiver_name['div'])) ?  $receiver_name['div'][0]['divcode'] : '';

        $receiver_name['axs_where'] = array( 'axs.secno' => $value['receiver_secno'] );
        $receiver_name['sec'] = $this->Embismodel->selectdata('acc_xsect AS axs', '', $receiver_name['axs_where'] );
        $receiver_sec = (!empty($receiver_name['sec'])) ? '|'.$receiver_name['sec'][0]['secode'] : '';

        $this->dmsdata['receiver_name'][$key] = $receiver_div.$receiver_sec.' - ';

        if($value['multiprc'] > 0)
        {
          $where['etml'] = array(
            'etml.trans_no'           => $value['trans_no'],
            'etml.main_route_order'   => $value['route_order'],
            'etml.route_order'        => 1,
            'etml.main_multi_cntr'    => $value['multi_cntr'],
          );
          $this->dmsdata['multitrans_histo'] = $this->Embismodel->selectdata('er_transactions_log AS etml', '', $where['etml'] );
        }
      }

      $this->load->view('Dms/func/view_transaction', $this->dmsdata);
    }

    //balhin rah unya
    function multitrans_history()
    {
      $mt_order = explode('_', $this->input->post('multitrans'));

      $trans_where = array( 'etm.trans_no' => $mt_order[1], );
      $this->dmsdata['trans_data'] = $this->Embismodel->selectdata('er_transactions_multi AS etm', '', $trans_where);

      $data = array(
        'trans_no'          => $mt_order[1],
        'main_route_order'  => $mt_order[2],
        'main_multi_cntr'   => $mt_order[3],
        'multi_cntr'        => $mt_order[4],
      );
      // query of transaction's log
      $history_where = array(
        'etl.trans_no'          => $data['trans_no'],
        'etl.main_route_order'  => $data['main_route_order'],
        'etl.main_multi_cntr'   => $data['main_multi_cntr'],
        'etl.multi_cntr'        => $data['multi_cntr'],
      );
      $history_order = $this->db->order_by('etl.route_order ASC, etl.multiprc ASC');
      $this->dmsdata['trans_history'] = $this->Embismodel->selectdata('er_transactions_log AS etl', '', $history_where, $history_order );

      $where['inthread'] = $this->db->where('etl.trans_no = "'.$data['trans_no'].'" AND etl.main_multi_cntr = "'.$data['main_multi_cntr'].'" AND etl.multi_cntr = "'.$data['multi_cntr'].'" AND ( etl.sender_id = "'.$this->dmsdata['user_token'].'" OR etl.receiver_id =  "'.$this->dmsdata['user_token'].'" )');

      $this->dmsdata['prnl_inthread'] = $this->Embismodel->selectdata('er_transactions_log AS etl', '', '', $where['inthread'] );

      $where['onlowerthread'] = $this->db->where('etl.trans_no = "'.$data['trans_no'].'" AND ( etl.sender_id = "'.$this->dmsdata['user_token'].'" OR etl.receiver_id =  "'.$this->dmsdata['user_token'].'" )');
      $this->dmsdata['onlowerthread'] = $this->Embismodel->selectdata('er_transactions_log AS etl', '', '', $where['onlowerthread'] );

      // CHECK IF USER IS UNDER THIS MULTIPLE ROUTE ROW
      $this->dmsdata['prnl_onlowerthread'] = '';

      $muti_histo_mmccheck = mb_strlen($data['main_multi_cntr'], 'UTF-8');
      foreach ($this->dmsdata['onlowerthread'] as $key => $value)
      {
        $onlowerthread_mmccheck = substr($value['main_multi_cntr'], 0, $muti_histo_mmccheck);

        if($data['main_multi_cntr'] == $onlowerthread_mmccheck && $value['main_multi_cntr'][$muti_histo_mmccheck+1] == $data['multi_cntr'])
        {
          $this->dmsdata['prnl_onlowerthread']=1;
          break;
        }
      }


      $x_mcnt = explode('-', $mt_order[3]);
      $x_mcntr = '';
      $i=1;

      while($i < count($x_mcnt)) {
        $x_mcntr .= $x_mcnt[$i];
        if($i+1 < count($x_mcnt)) {
          $x_mcntr .= '-';
        }
        $i++;
      }

      // query of attachments
      foreach ($this->dmsdata['trans_history'] as $key => $value) {

        $from_name['axd_where'] = array( 'axd.divno' => $value['sender_divno'] );
        $from_name['div'] = $this->Embismodel->selectdata('acc_xdvsion AS axd', '', $from_name['axd_where'] );
        $from_div = (!empty($from_name['div'])) ?  $from_name['div'][0]['divcode'] : '';

        $from_name['axs_where'] = array( 'axs.secno' => $value['sender_secno'] );
        $from_name['sec'] = $this->Embismodel->selectdata('acc_xsect AS axs', '', $from_name['axs_where'] );
        $from_sec = (!empty($from_name['sec'])) ? '|'.$from_name['sec'][0]['secode'] : '';

        $this->dmsdata['from_name'][$key] = $from_div.$from_sec.' - ';

        $receiver_name['axd_where'] = array( 'axd.divno' => $value['receiver_divno'] );
        $receiver_name['div'] = $this->Embismodel->selectdata('acc_xdvsion AS axd', '', $receiver_name['axd_where'] );
        $receiver_div = (!empty($receiver_name['div'])) ?  $receiver_name['div'][0]['divcode'] : '';

        $receiver_name['axs_where'] = array( 'axs.secno' => $value['receiver_secno'] );
        $receiver_name['sec'] = $this->Embismodel->selectdata('acc_xsect AS axs', '', $receiver_name['axs_where'] );
        $receiver_sec = (!empty($receiver_name['sec'])) ? '|'.$receiver_name['sec'][0]['secode'] : '';

        $this->dmsdata['receiver_name'][$key] = $receiver_div.$receiver_sec.' - ';

        if($key == 0)
        {
          $etm_hist_0_where = array(
            'eat.trans_no'          => $data['trans_no'],
            'eat.route_order'       => $data['main_route_order'],
            'eat.main_multi_cntr'   => $x_mcntr,
            'eat.multi_cntr'        => $x_mcnt[$i-1],
            'eat.deleted'           => 0,
          );
          $etm_hist_0_order = $this->db->order_by(' eat.route_order desc, eat.file_id desc');
          $this->dmsdata['attachment_view'][0] = $this->Embismodel->selectdata('er_attachments AS eat', '', $etm_hist_0_where, $etm_hist_0_order );
        }
        else {
          $ea_where = array(
            'eat.trans_no'          => $value['trans_no'],
            // 'eat.main_route_order'  => $data['main_route_order'], // UNCOMMENT IF NAGKAKA.ANO NA NAMN
            'eat.route_order'       => $value['route_order'],
            'eat.main_multi_cntr'   => $data['main_multi_cntr'],
            'eat.multi_cntr'        => $data['multi_cntr'],
            'eat.deleted'           => 0,
          );
          $ea_order = $this->db->order_by(' eat.route_order desc, eat.file_id desc');
          $this->dmsdata['attachment_view'][$key] = $this->Embismodel->selectdata('er_attachments AS eat', '', $ea_where, $ea_order );
        }

        if($value['multiprc'] > 0)
        {
          $where['etml'] = array(
            'etml.trans_no'           => $value['trans_no'],
            'etml.main_route_order'   => $value['route_order'],
            'etml.route_order'        => 1,
            'etml.main_multi_cntr'    => (!empty($value['main_multi_cntr'])) ? $value['main_multi_cntr'].'-'.$value['multi_cntr'] : $value['multi_cntr'],
          );
          $this->dmsdata['multitrans_histo'] = $this->Embismodel->selectdata('er_transactions_log AS etml', '', $where['etml'] );

        }
      }
      $this->load->view('Dms/func/multitrans_view', $this->dmsdata);
    }

    private function receive_transaction()
    {
      $data =  array(
        'trans_no'      => $this->input->post('trans_no'),
        'multiprc'      => $this->input->post('multiprc'),
        'region'        => $this->session->userdata('region'),
        'sender_divno'  => $this->dmsdata['user_func']['divno'],
        'sender_secno'  => $this->dmsdata['user_func']['secno'],
        'sender_id'     => $this->session->userdata('token'),
        'date_in'       => date('Y-m-d H:i:s'),
      );

      if(!empty($data['multiprc'])) {
        $table['trnsctn'] = 'er_transactions_multi AS etrns';
      }
      else {
        $table['trnsctn'] = 'er_transactions AS etrns';
      }

      $where['trnsctn'] = array(
        'etrns.trans_no'     => $data['trans_no'],
        'etrns.receiver_id'  => $data['sender_id'],
      );
      $res['trnsctn'] = $this->Embismodel->selectdata($table['trnsctn'], '', $where['trnsctn'] );

      $acsender_where = array('ac.token' => $data['sender_id'] );
      $res['sndr'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $acsender_where );

      $mname = (!empty($res['sndr'][0]['mname']) ) ? ' '.$res['sndr'][0]['mname'][0].'. ' : ' ';
      $suffix = (!empty($res['sndr'][0]['suffix']) ) ? ' '.$res['sndr'][0]['suffix'] : '';

      $sender = $res['sndr'][0]['fname'].$mname.$res['sndr'][0]['sname'].$suffix;

      // CHECK IF TRANSACTION ALREADY RECEIVED BY USER
      $where['etl_check'] = array(
        'etl.trans_no'          => $this->input->post('trans_no'),
        'etl.main_route_order'  => !empty($res['trnsctn'][0]['main_route_order']) ? $res['trnsctn'][0]['main_route_order'] : '',
        'etl.route_order'       => $res['trnsctn'][0]['route_order']+1,
        'etl.main_multi_cntr'   => !empty($res['trnsctn'][0]['main_multi_cntr']) ? $res['trnsctn'][0]['main_multi_cntr'] : '',
        'etl.multi_cntr'        => !empty($res['trnsctn'][0]['multi_cntr']) ? $res['trnsctn'][0]['multi_cntr'] : 1, // default is 1
        'etl.multiprc'          => $this->input->post('multiprc'),
        'etl.sender_id'         => $data['sender_id'],
      );
      $res['etl_check'] = $this->Embismodel->selectdata('er_transactions_log etl', '', $where['etl_check'] );

      if(empty($res['etl_check']))
      {
        $trans_log_insert = array(
          'trans_no'          => $res['trnsctn'][0]['trans_no'],
          'main_route_order'  => !empty($res['trnsctn'][0]['main_route_order']) ? $res['trnsctn'][0]['main_route_order'] : '',
          'route_order'       => $res['trnsctn'][0]['route_order']+1,
          'multiprc'          => 0,
          'main_multi_cntr'   => !empty($res['trnsctn'][0]['main_multi_cntr']) ? $res['trnsctn'][0]['main_multi_cntr'] : '',
          'multi_cntr'        => !empty($res['trnsctn'][0]['multi_cntr']) ? $res['trnsctn'][0]['multi_cntr'] : 1, // default is 1
          'sender_divno'      => $data['sender_divno'],
          'sender_secno'      => $data['sender_secno'],
          'sender_id'         => $data['sender_id'],
          'sender_name'       => $sender,
          'sender_ipadress'   => $this->input->ip_address(),
          'sender_region'     => $this->dmsdata['user_region'],
          'date_in'           => $data['date_in'],
        );
        $result = $this->Embismodel->insertdata('er_transactions_log', $trans_log_insert);

        if($result)
        {
          $set['trnsctn'] = array( 'etrns.receive' => 1, );
          if(!empty($data['multiprc']))
          {
            $where['trnsctn'] = array(
              'etrns.trans_no'          => $data['trans_no'],
              'etrns.receiver_id'       => $data['sender_id'],
              'etrns.main_route_order'  => !empty($res['trnsctn'][0]['main_route_order']) ? $res['trnsctn'][0]['main_route_order'] : '',
              'etrns.route_order'       => $res['trnsctn'][0]['route_order'],
              'etrns.multiprc'          => 0,
              'etrns.main_multi_cntr'   => !empty($res['trnsctn'][0]['main_multi_cntr']) ? $res['trnsctn'][0]['main_multi_cntr'] : '',
              'etrns.multi_cntr'        => $res['trnsctn'][0]['multi_cntr'], // default is 1
            );
          }
          else {
            $where['trnsctn'] = array(
              'etrns.trans_no'    => $data['trans_no'],
              'etrns.receiver_id' => $data['sender_id'],
            );
          }
          $result = $this->Embismodel->updatedata( $set['trnsctn'], $table['trnsctn'], $where['trnsctn'] );
        }
      }
      else {
        $result = true;
      }

      if($result)
      {
        $res['error'] = 0;
        $res['site'] = base_url('Dms/Dms/inbox');
      }

      echo json_encode($res);
    }

    function m_receive_transaction()
    {
      $data =  array(
        'trans_no'        => $this->input->post('trans_no'),
        'main_multi_cntr' => $this->input->post('main_multi_cntr'),
        'multi_cntr'      => $this->input->post('multi_cntr'),
        'region'          => $this->session->userdata('region'),
        'sender_divno'    => $this->dmsdata['user_func']['divno'],
        'sender_secno'    => $this->dmsdata['user_func']['secno'],
        'sender_id'       => $this->session->userdata('token'),
        'date_in'         => date('Y-m-d H:i:s'),
      );

      $table['trnsctn'] = 'er_transactions_multi AS etrns';

      $where['trnsctn'] = array(
        'etrns.trans_no'      => $data['trans_no'],
        'main_multi_cntr'     => $this->input->post('main_multi_cntr'),
        'multi_cntr'          => $this->input->post('multi_cntr'),
        'etrns.receiver_id'   => $data['sender_id'],
      );
      $res['trnsctn'] = $this->Embismodel->selectdata($table['trnsctn'], '', $where['trnsctn'] );

      $acsender_where = array('ac.token' => $data['sender_id'] );
      $res['sndr'] = $this->Embismodel->selectdata('acc_credentials AS ac', '', $acsender_where );

      $mname = (!empty($res['sndr'][0]['mname']) ) ? ' '.$res['sndr'][0]['mname'][0].'. ' : ' ';
      $suffix = (!empty($res['sndr'][0]['suffix']) ) ? ' '.$res['sndr'][0]['suffix'] : '';

      $sender = $res['sndr'][0]['fname'].$mname.$res['sndr'][0]['sname'].$suffix;

      // CHECK IF TRANSACTION ALREADY RECEIVED BY USER
      $where['etl_check'] = array(
        'etl.trans_no'          => $data['trans_no'],
        'etl.main_route_order'  => !empty($res['trnsctn'][0]['main_route_order']) ? $res['trnsctn'][0]['main_route_order'] : '',
        'etl.route_order'       => $res['trnsctn'][0]['route_order']+1,
        'etl.main_multi_cntr'   => !empty($res['trnsctn'][0]['main_multi_cntr']) ? $res['trnsctn'][0]['main_multi_cntr'] : '',
        'etl.multi_cntr'        => !empty($res['trnsctn'][0]['multi_cntr']) ? $res['trnsctn'][0]['multi_cntr'] : 1, // default is 1
        'etl.multiprc'          => 0,
        'etl.sender_id'         => $data['sender_id'],
      );
      $res['etl_check'] = $this->Embismodel->selectdata('er_transactions_log etl', '', $where['etl_check'] );

      if(empty($res['etl_check']))
      {
        $trans_log_insert = array(
          'trans_no'          => $res['trnsctn'][0]['trans_no'],
          'main_route_order'  => !empty($res['trnsctn'][0]['main_route_order']) ? $res['trnsctn'][0]['main_route_order'] : '',
          'route_order'       => $res['trnsctn'][0]['route_order']+1,
          'multiprc'          => 0,
          'main_multi_cntr'   => !empty($res['trnsctn'][0]['main_multi_cntr']) ? $res['trnsctn'][0]['main_multi_cntr'] : '',
          'multi_cntr'        => !empty($res['trnsctn'][0]['multi_cntr']) ? $res['trnsctn'][0]['multi_cntr'] : 1, // default is 1
          'sender_divno'      => $data['sender_divno'],
          'sender_secno'      => $data['sender_secno'],
          'sender_id'         => $data['sender_id'],
          'sender_name'       => $sender,
          'sender_ipadress'   => $this->input->ip_address(),
          'sender_region'     => $this->dmsdata['user_region'],
          'date_in'           => $data['date_in'],
        );
        $result = $this->Embismodel->insertdata('er_transactions_log', $trans_log_insert);

        if($result)
        {
          $set['trnsctn'] = array( 'etrns.receive' => 1, );
          $where['trnsctn'] = array(
            'etrns.trans_no'          => $data['trans_no'],
            'etrns.receiver_id'       => $data['sender_id'],
            'etrns.main_route_order'  => !empty($res['trnsctn'][0]['main_route_order']) ? $res['trnsctn'][0]['main_route_order'] : '',
            'etrns.route_order'       => $res['trnsctn'][0]['route_order'],
            'etrns.multiprc'          => 0,
            'etrns.main_multi_cntr'   => !empty($res['trnsctn'][0]['main_multi_cntr']) ? $res['trnsctn'][0]['main_multi_cntr'] : '',
            'etrns.multi_cntr'        => $res['trnsctn'][0]['multi_cntr'], // default is 1
          );
          $result = $this->Embismodel->updatedata( $set['trnsctn'], $table['trnsctn'], $where['trnsctn'] );
        }
      }
      else {
        $result = true;
      }

      if($result)
      {
        $res['error'] = 0;
        $res['site'] = base_url('Dms/Dms/inbox');
      }

      echo json_encode($res);
    }

    // File upload
    function fileUpload()
    {
      // TRANSACTION COUNTER
      $this->dmsdata['cnt'] = (!empty($this->dmsdata['cnt'])) ? $this->dmsdata['cnt']++ : 1;
      $data = array(
        'user_token'        => $this->dmsdata['user_token'],
        'trans_region'      => $this->input->post('region'),
        'trans_session'     => $this->input->post('trans_session'),
        'main_route_order'  => !empty($this->input->post('main_route_order')) ? trim($this->input->post('main_route_order')) : '',
        'route_order'       => $this->input->post('route_order')+1,
        // 'main_multi_cntr'   => !empty($this->input->post('main_multi_cntr')) ? trim($this->input->post('main_multi_cntr')) : '',
        'main_multi_cntr'   => !empty($this->session->userdata('main_multi_cntr')) ? trim($this->session->userdata('main_multi_cntr')) : '',
        'multi_cntr'        => !empty($this->session->userdata('multi_cntr')) ? $this->session->userdata('multi_cntr') : 1,
      );

      $path = 'dms/'.date('Y').'/'.$data['trans_region'].'/';
      $folder = $data['trans_session'];

      if(!is_dir('uploads/'.$path.'/'.$folder)) {
        mkdir('uploads/'.$path.'/'.$folder, 0777, TRUE);
      }

      $mcntr = '';
      $m_addpath = '';

      if(!empty($data['main_multi_cntr']))
      {
        // make folder for sub/branch trans_no
        // $m_cnt = explode('-', $data['main_multi_cntr']);
        // for ($i=0; $i < count($m_cnt); $i++) {
        //   $m_addpath .= $m_cnt[$i];
        //   if($i < count($m_cnt)-1) {
        //     $m_addpath .= '/';
        //   }
        // }

        // if(!is_dir('uploads/'.$path.'/'.$folder.'/'.$m_addpath)) {
        //   mkdir('uploads/'.$path.'/'.$folder.'/'.$m_addpath, 0777, TRUE);
        // }
        // rename and include mcntr to new attachment name
        // multiple user routing file coding
        $mcntr = '-RC'.$data['main_route_order'].'MC'.$data['main_multi_cntr'].'-'.$data['multi_cntr'];
      }

      $region_where = array('ar.rgnnum' => $data['trans_region'] );
      $region_data = $this->Embismodel->selectdata('acc_region AS ar', '', $region_where );

      $trans_where = array('et.trans_no' => $data['trans_session'] );
      $trans_data = $this->Embismodel->selectdata('er_transactions AS et', '', $trans_where );
      $date = date('Y', strtotime($trans_data[0]['start_date']));

      $att_token1 = fmod($data['trans_session'], 1000000);

      // select,insert, update and delete queries from er_attachments db must include multi_cntr
      $ea_w = array(
        'ea.trans_no'           => $data['trans_session'],
        'ea.main_route_order'   => $data['main_route_order'],
        'ea.route_order'        => $data['route_order'],
        'ea.main_multi_cntr'    => $data['main_multi_cntr'],
        'ea.multi_cntr'         => $data['multi_cntr'],
        'ea.deleted'            => 0,
      );
      $ea_q = $this->Embismodel->selectdata('er_attachments AS ea', 'MAX(ea.file_id) AS max_fileid', $ea_w);
      // total file coding
      $att_token = $data['trans_region'].$date.$mcntr.'-FT'.$data['route_order'].'N'.$att_token1.'-File_'.($ea_q[0]['max_fileid']+1);

      if(!empty($_FILES['file']['name'])) {
        // Set preference
        $config = array(
          'upload_path'   => 'uploads/'.$path.'/'.$folder, // .'/'.$m_addpath
          'allowed_types' => '*',
          'max_size'      => '20480', // max_size in kb
          'file_name'     => $att_token,
          'overwrite'     => FALSE,
        );
        //Load upload library
        $this->load->library('upload', $config);
        $this->upload->initialize($config);
        // File upload
        if(!$this->upload->do_upload('file')) {
          // Show error on uploading
          $uploadError = array('error' => $this->upload->display_errors());
        }
        else {
          // Get data about the file
          $uploadData = $this->upload->data();
          $erattach_insert = array(
            'trans_no'          => $data['trans_session'],
            'main_route_order'  => $data['main_route_order'],
            'route_order'       => $data['route_order'],
            'main_multi_cntr'   => $data['main_multi_cntr'],
            'multi_cntr'        => $data['multi_cntr'],
            'file_id'           => $ea_q[0]['max_fileid']+1, // order_by
            'token'             => $att_token,
            'file_name'         => $_FILES['file']['name'],
          );
          $this->Embismodel->insertdata('er_attachments', $erattach_insert);
        }
      }
    }

    // File Delete
    function fileDelete()
    {
      $error = 1;
      // TRANSACTION COUNTER
      $this->dmsdata['cnt'] = (!empty($this->dmsdata['cnt'])) ? $this->dmsdata['cnt']++ : 1;
      $data = array(
        'user_token'        => $this->dmsdata['user_token'],
        'trans_region'      => $this->input->post('region'),
        'trans_session'     => $this->input->post('trans_session'),
        'main_route_order'  => !empty($this->input->post('main_route_order')) ? trim($this->input->post('main_route_order')) : '',
        'route_order'       => $this->input->post('route_order')+1,
        'main_multi_cntr'   => !empty($this->input->post('main_multi_cntr')) ? trim($this->input->post('main_multi_cntr')) : '',
        'multi_cntr'        => !empty($this->input->post('multi_cntr')) ? $this->input->post('multi_cntr') : 1,
        'file_name'         => $this->input->post('file_name'),
        'file_token'        => $this->input->post('file_token'),
      );

      $where = array( 'et.trans_no' => $data['trans_session'] );
      $et_query = $this->Embismodel->selectdata('er_transactions AS et', '', $where);

      // echo "<pre>"; print_r($data);

      $path = 'dms/'.date('Y', strtotime($et_query[0]['start_date'])).'/'.$et_query[0]['region'];
      $folder = $data['trans_session'];

      $whole_path = 'uploads/'.$path.'/'.$folder.'/'.$data['file_token'].'.'.pathinfo($data['file_name'], PATHINFO_EXTENSION);
      // echo $whole_path;
      if(!empty($data['file_token']))
      {
        // chown($whole_path, 777);

        if (unlink($whole_path)) {
            echo 'success';

            // $ea_w = array(
            //   'trans_no'           => $data['trans_session'],
            //   'main_route_order'   => $data['main_route_order'],
            //   'route_order'        => $data['route_order'],
            //   'main_multi_cntr'    => $data['main_multi_cntr'],
            //   'multi_cntr'         => $data['multi_cntr'],
            //   'file_name'          => $data['file_name'],
            //   'token'              => $data['file_token'],
            // );
            // $ea_q = $this->Embismodel->deletedata('er_attachments', $ea_w);

            $ea_set = array(
              'deleted'           => 1,
            );
            $ea_w = array(
              'trans_no'           => $data['trans_session'],
              'main_route_order'   => $data['main_route_order'],
              'route_order'        => $data['route_order'],
              'main_multi_cntr'    => $data['main_multi_cntr'],
              'multi_cntr'         => $data['multi_cntr'],
              'file_name'          => $data['file_name'],
              'token'              => $data['file_token'],
            );
            $ea_q = $this->Embismodel->updatedata( $ea_set, 'er_attachments', $ea_w);

            if($ea_q) {
              echo 'delete success';
            }
            else  {
              echo 'delete failed';
            }

        } else {
            echo 'fail';
            $error = 0;
        }
      }
      return json_encode($error);
    }

    function system_select()
    {
      $system = $this->input->post('system');
      $type_vars = array(
        'where' => array(
          'et.sysid'    => $system,
          'et.id !='    => 83,
          'et.sys_show' => 0,
        ),
        'order' => $this->db->order_by('et.sysid asc, et.ssysid asc, et.header desc'),
      );
      $typeq = $this->Embismodel->selectdata('er_type AS et', '', $type_vars['where'], $type_vars['order']);
      echo json_encode($typeq);
    }

    function select_region()
    {
      $region_name = $this->session->userdata('region');
      $div_where = '';

      if(!empty($this->input->post('region_name'))) {
        $type = ($this->input->post('region_name') == 'CO') ? 'co' : 'region';
        // $div_where = array( 'axd.type'  => $type, 'axd.office' =>'EMB' );

        if($this->input->post('region_name') == $region_name || $this->session->userdata('func') == 'Director')
        {
          $div_restriction = '1';
        }
        else {
          $div_restriction = 'axd.divno IN (2, 6)';
        }

        $where['xdvsion'] = $this->db->where('axd.type = "'.$type.'" AND axd.office = "EMB" AND '.$div_restriction);
      }

      $division = $this->Embismodel->selectdata('acc_xdvsion AS axd', '', '', $where['xdvsion']);
      echo json_encode($division);
    }

    function select_division()
    {
      $division_name = $this->input->post('division_name');
      $region = (!empty($this->input->post('region_name'))) ? $this->input->post('region_name') : $this->session->userdata('region');

      $where['axsna_xsect'] = array('axsna.region' => $region);
      $exclude_sect = $this->Embismodel->selectdata('acc_xsect_not_applicable AS axsna', '', $where['axsna_xsect'] );
      $xsct = '0';

      if(!empty($exclude_sect))
      {
        foreach($exclude_sect as $key => $value) {
          if(count($exclude_sect)-1 == $key)
          {
            $xsct .= $value['secno'];
          }
          else {
            $xsct .= $value['secno'].',';
          }
        }
      }

      // if($this->session->userdata('region') == $region || $this->session->userdata('func') == 'Director')
      // {
        $sec_restriction = '1';
      // }
      // else {
      //   $sec_restriction = 'axs.secno IN (77, 166, 176, 195, 223, 231, 232, 235, 255, 279, 316)';
      // }

      if($region != 'CO') {
        $where['xsect'] = $this->db->where('axs.divno = "'.$division_name.'" AND ( axs.region = "'.$region.'" OR axs.region = "R" ) AND axs.secno NOT IN ('.$xsct.') AND '.$sec_restriction);
      }
      else {
        $where['xsect'] = $this->db->where('axs.divno = "'.$division_name.'" AND axs.region = "'.$region.'" AND '.$sec_restriction);
      }
      $division = $this->Embismodel->selectdata('acc_xsect AS axs', '', '', $where['xsect']);
      echo json_encode($division);
    }

    function select_section()
    {
      $region = (!empty($this->input->post('region_name'))) ? $this->input->post('region_name') : $this->session->userdata('region');
      $section_name = (!empty($this->input->post('section_name'))) ? $this->input->post('section_name') : 0;
      $division_name = $this->input->post('division_name');

      $af_where = array('af.stat' => 1, 'af.secno' => $section_name, 'af.divno' => $division_name, 'af.region' => $region);
      $func_grp = $this->db->group_by("userid");
      $func = $this->Embismodel->selectdata('acc_function AS af', '', $af_where, $func_grp);
      $personnel = '';
      foreach ($func as $key => $value) {
        $sec_where = array(
          'ac.userid'   => $value['userid'],
          'ac.verified' => 1
        );
        $personnel1_grp = $this->db->group_by("userid");
        $personnel1 = $this->Embismodel->selectdata('acc_credentials AS ac', '', $sec_where, $personnel1_grp);
        if(!empty($personnel1)) {
          $personnel[] = $personnel1[0];
        }
      }

      echo json_encode($personnel);
    }

    function company_list()
    {
      $where = array('dc.status' => '0' );
      $companyq = $this->Embismodel->selectdata('dms_company AS dc', 'emb_id, company_id, company_name, establishment_name, token', $where);
      echo json_encode($companyq);
    }

    function company_details()
    {
      $company_token = $this->input->post('company_token');
      $where = array('dc.token' => $company_token );
      $company_details = $this->Embismodel->selectdata('dms_company AS dc', '', $where);
      echo json_encode($company_details);
    }

    function transtable_filter()
    {
      $data['site'] = 'all_transactions';
      if($this->input->post('type') == 'filter') {
        $data['filter'] = array(
          'fltr_comp' => (!empty($this->input->post('filter_company'))) ? $this->input->post('filter_company') : '',
          'fltr_type' => (!empty($this->input->post('filter_transtype'))) ? $this->input->post('filter_transtype') : '',
          'fltr_stat' => (!empty($this->input->post('filter_status'))) ? $this->input->post('filter_status') : '',
        );
      }
      else {
        $data['filter'] = '';
      }

      $this->session->set_userdata( 'trans_filter', $data['filter']);
      echo json_encode($data);
    }

    function trans_qrcode()
    {
      $trans_stat = $this->input->post('trns_stat',TRUE);
      $token      = $this->encrypt->decode($this->input->post('token',TRUE));
      if(($this->session->userdata('trans_qrcode') == 'yes' OR $this->session->userdata('superadmin_rights') == 'yes')){
        $wheretrans    = $this->db->where('et.token = "'.$token.'"');
        $selecttrans   = $this->Embismodel->selectdata('er_transactions AS et','et.qr_code_token','',$wheretrans);
        $random        = str_split('QWERTYUIOP12345678'); shuffle($random);
        $randomkey     = array_slice($random, 0, 18);
        $key = implode('', $randomkey);
        $paded = str_pad($key, 18, '0', STR_PAD_LEFT);
        $delimited = '';
        if(empty($selecttrans[0]['qr_code_token'])){
          for($i = 0; $i < 18; $i++) {
           $delimited .= $paded[$i];
           if($i == 2 || $i == 5 || $i == 8 || $i == 11 || $i == 14) {
               $delimited .= '-';
           }
          }
        }else{
          $delimited = $selecttrans[0]['qr_code_token'];
        }
        echo "<label>Please copy and paste QR Code into the document to be routed:</label><br>";
        echo "<input type='hidden' class='form-control' name='qr_code' value='".$delimited."' readonly>";
        echo "<img src='https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=https%3A%2F%2Fiis.emb.gov.ph/verify?token=".$delimited."%2F&choe=UTF-8' style='width:150px;'>";
      }
    }

    function run_select_region()
    {
      $region_name = '';
      $div_where = '';

      if(!empty($this->input->post('region_name'))) {
        $type = ($this->input->post('region_name') == 'CO') ? 'co' : 'region';
        $div_where = array( 'axd.type'  => $type, );
      }
      else {
        $type = ($this->univdata['user_cred']['region'] == 'CO') ? 'co' : 'region';
        $div_where = array( 'axd.type'  => $type, 'axd.office' =>'EMB' );
      }

      $division = $this->Embismodel->selectdata('acc_xdvsion AS axd', '', $div_where);
      echo json_encode($division);
    }

    function run_select_division()
    {
      $division_name = !empty($this->input->post('division_name')) ? $this->input->post('division_name') : $this->univdata['user_cred']['divno'];
      $region = (!empty($this->input->post('region_name'))) ? $this->input->post('region_name') : $this->univdata['user_cred']['region'];

      $where['axsna_xsect'] = array('axsna.region' => $region);
      $exclude_sect = $this->Embismodel->selectdata('acc_xsect_not_applicable AS axsna', '', $where['axsna_xsect'] );
      $xsct = '0';

      if(!empty($exclude_sect))
      {
        foreach($exclude_sect as $key => $value) {
          if(count($exclude_sect)-1 == $key)
          {
            $xsct .= $value['secno'];
          }
          else {
            $xsct .= $value['secno'].',';
          }
        }
      }

      if($region != 'CO') {
        $where['xsect'] = $this->db->where('axs.divno = "'.$division_name.'" AND ( axs.region = "'.$region.'" OR axs.region = "R" ) AND axs.secno NOT IN ('.$xsct.')');
      }
      else {
        $where['xsect'] = $this->db->where('axs.divno = "'.$division_name.'" AND axs.region = "'.$region.'"');
      }
      $division = $this->Embismodel->selectdata('acc_xsect AS axs', '', '', $where['xsect']);
      echo json_encode($division);
    }

    function bulk_download()
    {
      $this->load->library('zip');

      $this->zip->clear_data();
      $value= $this->uri->segment(4);
      $x = explode('_', $value);

      $trans_no_calculated = !empty($x[4]) ? $x[0] : $x[0] - 10000000;

      $where['bulkdl'] = array(
        'eat.trans_no'        => $x[0],
        'eat.main_multi_cntr' => !empty($x[1]) ? $x[1] : '',
        'eat.route_order'     => $x[2],
        'eat.multi_cntr'      => $x[3],
      );
      $bulkdl = $this->Embismodel->selectdata('er_attachments eat', 'eat.token, eat.file_name', $where['bulkdl']);
      $where['ertrans'] = array(
        'et.trans_no'        => $x[0],
      );
      $ertrans = $this->Embismodel->selectdata('er_transactions et', '', $where['ertrans']);

      foreach ($bulkdl as $key => $value) {
        $this->zip->read_file(trim('./uploads/dms/'.date('Y', strtotime($ertrans[0]['start_date'])).'/'.$x[4].'/'.$trans_no_calculated.'/'.$value['token'].'.'.pathinfo($value['file_name'], PATHINFO_EXTENSION)));
      }

      $this->zip->download('iisfiles.zip');
    }

  }
?>
